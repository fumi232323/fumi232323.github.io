<!DOCTYPE html>
<html lang="ja-JP">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>サーバーに ssh 接続しようとしたら、 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! と言われた/32imuf.com</title>
    <link rel="shortcut icon" href="/static/icons/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/style.css?20190506">
  </head>

  <body>
    <div class="container">
      <div class="header"><header class="item item-header">
  <h1>
    <a href="/">
      <img class="logo" src="/static/images/inuu.png" alt="犬">
    </a>
  </h1>
  <nav class="nav">
    <ul>
      <li class="nav-category"><a href="/">HOME</a></li>
      
      
        
        <li class="nav-category">
          <a href="/index_category_category_aws.html">aws</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../aws/what-is-amazon-aurora/">Amazon Aurora とはなんですか？</a>
              </li>
            
              <li class="nav-article">
                <a href="../../aws/s3-response-error/">S3ResponseError の原因はなんと時刻ずれだった</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_blog.html">blog</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../blog/rules/">ブログを書くときの注意点</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_css.html">css</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../html-css/css/note/">CSS のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/configure-stylus-output-directory/">PyCharm の File Watcher で、 Stylus の CSS ファイル生成先ディレクトリを指定する。</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/stylus/">Stylus を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/html5-css3-modern-coding/">『HTML5/CSS3モダンコーディング フロントエンドエンジニアが教える3つの本格レイアウト スタンダード・グリッド・シングルページレイアウトの作り方』を読んで気になったことメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_django.html">django</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../django/manage/">Django: django-admin.py, manage.py</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/template/">Django: Template</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/view/">Django: View</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/urlconf/">Django: URL ディスパッチャ, URLconf</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/model/">Django: Model, Django ORM</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/note/">Django なんでもメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_docker.html">docker</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../docker/create-django-env-with-docker-compose-2/">Docker Compose で Django 環境をつくろう その2</a>
              </li>
            
              <li class="nav-article">
                <a href="../../docker/connect-from-sqla-to-mysqldb/">Docker Compose で MySQL DB をつくり Compose 外 (非 docker) の SQLAlchemy から接続する</a>
              </li>
            
              <li class="nav-article">
                <a href="../../docker/create-django-env-with-docker-compose-mysql-2/">Docker Compose で Django/MySQL 環境をつくる その2</a>
              </li>
            
              <li class="nav-article">
                <a href="../../docker/create-django-env-with-docker-compose-mysql/">Docker Compose で Django/MySQL 環境をつくる</a>
              </li>
            
              <li class="nav-article">
                <a href="../../docker/use-volumes-with-docker-compose/">Docker Compose で Volumes をつかう</a>
              </li>
            
              <li class="nav-article">
                <a href="../../docker/create-django-env-with-docker-compose/">Docker Compose で Django/PostgreSQL 環境をつくる</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_git.html">git</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../git/command/merge/">git merge</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/rebase-i/">git rebase -i</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/rebase/">git rebase</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/note/">Git のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/configuration/">Git の設定まとめ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/">Git のコマンドまとめ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_github.html">github</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../github/how-to-create-new-repository/">GitHub に新しいリポジトリを作成して、pushする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../github/github-pages-custom-domain-setting/">GitHub Pages にカスタムドメインを設定する</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_mac.html">mac</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../mac/note/">Mac のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_miyadaiku.html">miyadaiku</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../miyadaiku/build/">Miyadaiku ビルドするときのコマンド</a>
              </li>
            
              <li class="nav-article">
                <a href="../../miyadaiku/article-directory-structure/">article の置きかた</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_mysql.html">mysql</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../mysql/note/">MySQL のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_pycharm.html">pycharm</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../pycharm/django-support/">Pycharm の Django support を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/add-psql-var-to-user-params-for-db-console/">PyCharm の Database Console で PostgreSQL のプレースホルダー (インタポレーション) を SQL パラメーターとして使えるようにする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/connect-db-using-ssh-tunnel/">PyCharm で SSH tunnel して Amazon Redshift につなぐ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/useful-menu-and-shortcuts/">PyCharm ショートカットと便利メニュー</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/configuration/">PyCharm の設定</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_python.html">python</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../python/note/">Python のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python/etc/">Python いろいろメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python/pyconjp2018/">PyConJP 2018 で聞いた講演</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_redshift.html">redshift</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../redshift/note/">Redshift のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sample.html">sample</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../2018/sample-table/">table の sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../2018/sample-h1-h2-h3-li/">h1, h2, h3, リストの sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../2018/sample-code-block/">code-block, 引用の sample</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sql.html">sql</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../sql/note/">SQL のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sqlalchemy.html">sqlalchemy</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../sqlalchemy/note/">SQLAlchemy メモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_ssh.html">ssh</a>
          <ul>
            
              <li class="nav-article">
                <a href="../command/ssh-keygen/">ssh-keygen</a>
              </li>
            
              <li class="nav-article">
                <a href="../command/ssh-add/">ssh-add</a>
              </li>
            
              <li class="nav-article">
                <a href="../command/ssh/">ssh のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_test.html">test</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../python-test/tox/">tox</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python-test/mypy/">mypy</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python-test/note/">Python テストのメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vagrant.html">vagrant</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../vagrant/note/">Vagrant のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vim.html">vim</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../vim/command/">Vim のコマンド</a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </nav>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-ssh">
    <time class="date" datetime="2018-08-05 00:00:00+09:00">
      2018-08-05 Sun
    </time>
    <div class="title">サーバーに ssh 接続しようとしたら、 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! と言われた</div>
    <div class="category">
      <a href="/index_category_category_ssh.html">
          ssh
      </a>
    </div>
    <div class="text">
      <p>TODO: 残りを整理する。</p>
<div class="section" id="id1">
<div class="md_header_block" id="h_%E4%BA%8B%E8%B1%A1"><a class="md_header_anchor" id="a_%E4%BA%8B%E8%B1%A1"></a><h1>事象</h1></div>
<p>サーバーに ssh 接続しようとしたら、こんなエラーが出た。</p>
<blockquote>
<ul>
<li><p>エラーメッセージ(だいたいこんな感じ)</p>
<div class="code-block">
<div class="highlight"><pre><span></span>$ ssh <span class="o">{</span>接続先サーバー<span class="o">}</span>
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now <span class="o">(</span>man-in-the-middle attack<span class="o">)</span>!
It is also possible that a host key has just been changed.
The fingerprint <span class="k">for</span> the RSA key sent by the remote host is
SHA256:<span class="o">{</span>ここに fingerprint <span class="o">}</span>.
Please contact your system administrator.
Add correct host key in /Users/fumi23/.ssh/known_hosts to get rid of this message.
Offending RSA key in /Users/fumi23/.ssh/known_hosts:3
RSA host key <span class="k">for</span> <span class="o">{</span>ここに 接続先サーバーの HostName <span class="o">}</span> has changed and you have requested strict checking.
Host key verification failed.
ssh_exchange_identification: Connection closed by remote host
</pre></div>
</div>
</li>
</ul>
</blockquote>
</div>
<div class="section" id="id2">
<div class="md_header_block" id="h_%E5%8E%9F%E5%9B%A0"><a class="md_header_anchor" id="a_%E5%8E%9F%E5%9B%A0"></a><h1>原因</h1></div>
<p>チームの方が教えてくれました。 (ありがとうございました。)</p>
<ul class="simple">
<li><p>接続先サーバーの RSA 公開鍵のフィンガープリントが変わっていたため。</p>
<ul>
<li><p>上記のエラーは、接続先サーバーの RSA 公開鍵のフィンガープリントが変わってますよ、というエラー。</p></li>
<li><p>サーバーの入れ替えなどすると、 RSA 公開鍵のフィンガープリントは変わる。</p></li>
<li><p><cite>エラーメッセージちゃんと読むと、MITM攻撃ありえるから、気を利かしてエラーにしてる感じ</cite> なのだそうです。</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id3">
<div class="md_header_block" id="h_%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><a class="md_header_anchor" id="a_%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"></a><h1>解決方法</h1></div>
<ol class="arabic">
<li><p>known_hostsファイルから、接続先サーバーの HostName に属する鍵をすべて取り除く。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ ssh-keygen -R <span class="o">{</span>ここに 接続先サーバーの HostName <span class="o">}</span>
<span class="c1"># Host {ここに 接続先サーバーの HostName } found: line 3</span>
/Users/fumi23/.ssh/known_hosts updated.
Original contents retained as /Users/fumi23/.ssh/known_hosts.old
</pre></div>
</div>
</blockquote>
</li>
<li><p>ssh でアクセスし直す。</p></li>
<li><p>「あなたが接続しようとしているサーバーの fingerprint はこれか？」と尋ねられるので、 <span class="docutils literal">yes</span> と答える。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ ssh <span class="o">{</span>接続先サーバー<span class="o">}</span>
The authenticity of host <span class="s1">'{ここに 接続先サーバーの HostName } ({ここに 接続先サーバーの IPアドレス })'</span> can<span class="s1">'t be established.</span>
<span class="s1">ECDSA key fingerprint is SHA256:(ここに 新しい fingerprint ).</span>
<span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
<span class="s1">Warning: Permanently added '</span><span class="o">{</span>ここに 接続先サーバーの HostName <span class="o">}</span>,<span class="o">{</span>ここに 接続先サーバーの IPアドレス <span class="o">}</span><span class="s1">' (ECDSA) to the list of known hosts.</span>
<span class="s1">The authenticity of host '</span><span class="o">{</span>ここに 接続先サーバーその2の HostName <span class="o">}</span> <span class="o">(</span>&lt;no hostip <span class="k">for</span> proxy command&gt;<span class="o">)</span><span class="s1">' can'</span>t be established.
RSA key fingerprint is SHA256:<span class="o">(</span>ここに 新しい fingerprint その2 <span class="o">)</span>.
Are you sure you want to <span class="k">continue</span> connecting <span class="o">(</span>yes/no<span class="o">)</span>? yes
Warning: Permanently added <span class="s1">'{ここに 接続先サーバーその2の HostName }'</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
Last login: Fri Jul <span class="m">13</span> <span class="m">15</span>:43:09 <span class="m">2018</span> from <span class="m">172</span>.31.7.69
</pre></div>
</div>
</blockquote>
</li>
<li><p>接続できました。</p></li>
</ol>
<div class="section" id="fingerprint">
<div class="md_header_block" id="h_fingerprint%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%A7%E3%81%99%E3%81%8B"><a class="md_header_anchor" id="a_fingerprint%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%A7%E3%81%99%E3%81%8B"></a><h2>fingerprint とは何ですか</h2></div>
<ul>
<li><p>流れとしては、</p>
<ol class="arabic">
<li><p>秘密鍵は自分持ってる</p></li>
<li><p>公開鍵はサーバーに書く</p></li>
<li><p>ssh 1回目に、「あなたが接続しようとしているサーバー（が持ってるRSA公開鍵の）フィンガープリントこれでいい？」って聞かれる</p></li>
<li><p>「いいよ」っていうと自分のマシンの  <span class="docutils literal">known_hosts</span> に書かれる。</p>
<blockquote>
<ul>
<li><p><span class="docutils literal">known_hosts</span> ファイルに、</p>
<div class="code-block">
<div class="highlight"><pre><span></span>サーバーのHostName 鍵のタイプ 謎の文字列
</pre></div>
</div>
<p>の形式で書かれる。</p>
</li>
<li><p><span class="docutils literal">known_hosts</span> は覚書きみたいなもの。このサーバーは知ってるひと、伊原に住んでる fumi さんでしょ、合言葉は「おとといきやがれ」。みたいな。</p></li>
<li><p><span class="docutils literal">known_hosts</span> に書かれる謎の文字列は、公開鍵の文字列と似ているけれど、違う。なんか暗号化とかしてるの？フィンガープリントを。</p></li>
</ul>
</blockquote>
</li>
</ol>
<blockquote>
<ol class="arabic simple" start="5">
<li><p>ssh 2回目以降は、 <span class="docutils literal">known_hosts</span> に書いておいた覚書きを照会して、知り合いか否かを判定する。</p></li>
</ol>
</blockquote>
</li>
</ul>
<p>TODO: ここから整理中</p>
<ul class="simple">
<li><p>なんのために、フィンガープリントを送ってくるかというと、「あなたが接続しようとしているサーバーはこちらでよろしいですか？」という確認のため。</p></li>
<li><p>公開鍵をそのまま送っちゃうと危険だから、 <span class="docutils literal">SHA256</span> (ハッシュ) して、送ってくれる。</p></li>
<li><p>サーバー入れ替えとかすると、フィンガープリントは変わる (とのこと)。</p></li>
<li><p>でも鍵が変わっているわけではない</p></li>
<li><p><span class="docutils literal">SHA256</span> はハッシュだから、同じ元値からは必ず同じハッシュ値が生成されるはず</p></li>
<li><p>ということは、単純に公開鍵から生成しているわけではなさそう</p></li>
<li><p>公開鍵 ( +α ) から生成されるんだろう</p></li>
<li><p>送り主のサーバーは公開鍵しか持ってないしな</p></li>
<li><p>でも変えられちゃったら、念のため手元にとっておいた公開鍵に対応するフィンガープリントなのかわからなくなっちゃう・・</p></li>
<li><p>いやたぶん、一番最初、サーバーに公開鍵を置いたばかりのタイミングでは、<cite>$ ssh-keygen -l -f id_rsa_test1.pub</cite> したやつと同じフィンガープリントを
送りつけてくるんだろう</p></li>
<li><p>試したい・・・</p></li>
</ul>
<p>あ、わかった
ここだ</p>
<p><a class="reference external" href="http://www.unixuser.org/~euske/doc/openssh/book/chap3.html">http://www.unixuser.org/~euske/doc/openssh/book/chap3.html</a>
3.2.3. なりすましを防ぐしくみ</p>
<p>公開鍵、って言ってるやつは、ふたつに分かれていたんだ、ホスト公開鍵とホスト秘密鍵</p>
<p>通常はこのようなことが起こらないよう、 クライアントはサーバに接続した瞬間に、まず暗号化された通信を介して そのサーバのホスト鍵 (host key) を確認し、
それが本当に自分のログインしたいサーバであるかどうか確かめます。
ホスト鍵は <span class="docutils literal">ホスト公開鍵</span> と <span class="docutils literal">ホスト秘密鍵</span> に分かれており、 クライアント上には通常 known_hosts と呼ばれるファイルがあり、
ここには特定の IPアドレス (とホスト名) をもつサーバの <span class="docutils literal">ホスト公開鍵</span> が登録されています。
ホスト秘密鍵はサーバマシン内のディスクに格納されており、 ネットワーク上に持ち出されることはありません。
クライアントは、まずこの known_hosts ファイル内に登録されているホスト公開鍵と、
サーバから送られてくるホスト公開鍵を照合し (図 what-is-host-authentication)、
サーバが実際にこのホスト公開鍵に対応するホスト秘密鍵をもっているかどうか確認します。
この確認には公開鍵暗号技術が使われており、 サーバは実際のホスト秘密鍵をネットワーク上に送信することなく、
ホスト秘密鍵の所有を クライアント側に証明できるようになっています (コラム - 公開鍵をつかった認証のしくみ 参照)。</p>
<p>TODO: あした、↑たしかめよう</p>
</div>
</div>
<div class="section" id="id4">
<div class="md_header_block" id="h_%E5%AE%BF%E9%A1%8C"><a class="md_header_anchor" id="a_%E5%AE%BF%E9%A1%8C"></a><h1>宿題</h1></div>
<ul class="simple">
<li><p><span class="docutils literal">中間者攻撃</span> とは何ですか。</p></li>
</ul>
</div>
<div class="section" id="id5">
<div class="md_header_block" id="h_%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"><a class="md_header_anchor" id="a_%E5%8F%82%E8%80%83%E3%82%B5%E3%82%A4%E3%83%88"></a><h1>参考サイト</h1></div>
<ul class="simple">
<li><p><a class="reference external" href="https://www.freebsd.org/cgi/man.cgi?query=ssh-keygen&amp;apropos=0&amp;sektion=1&amp;manpath=CentOS+6.5&amp;arch=default&amp;format=html">SSH-KEYGEN(1)</a></p></li>
<li><p><a class="reference external" href="http://note.crohaco.net/2014/public-key-basic-config/">秘密鍵/公開鍵の基本的な設定</a></p></li>
<li><p><a class="reference external" href="http://www.unixuser.org/~euske/doc/openssh/book/chap3.html">第3章 OpenSSH のしくみ</a></p></li>
</ul>
<p>ありがとうございました。</p>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>

</html>