<!DOCTYPE html>
<html lang="ja-JP">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Docker Compose で Django/MySQL 環境をつくる/32imuf.com</title>
    <link rel="shortcut icon" href="/static/icons/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/style.css?20181123">
  </head>

  <body>
    <div class="container">
      <div class="header"><header class="item item-header">
  <h1>
    <a href="/">
      <img class="logo" src="/static/images/inuu.png" alt="犬">
    </a>
  </h1>
  <nav class="nav">
    <ul>
      <li class="nav-category"><a href="/">HOME</a></li>
      
      
        
        <li class="nav-category">
          <a href="/index_category_category_aws.html">aws</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../aws/what-is-amazon-aurora/">Amazon Aurora とはなんですか？</a>
              </li>
            
              <li class="nav-article">
                <a href="../../aws/s3-response-error/">S3ResponseError の原因はなんと時刻ずれだった</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_blog.html">blog</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../blog/rules/">ブログを書くときの注意点</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_css.html">css</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../html-css/css/note/">CSS のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/configure-stylus-output-directory/">PyCharm の File Watcher で、 Stylus の CSS ファイル生成先ディレクトリを指定する。</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/stylus/">Stylus を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../html-css/html5-css3-modern-coding/">『HTML5/CSS3モダンコーディング フロントエンドエンジニアが教える3つの本格レイアウト スタンダード・グリッド・シングルページレイアウトの作り方』を読んで気になったことメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_django.html">django</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../django/note/">Django のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../django/django_orm/">Django ORM のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_docker.html">docker</a>
          <ul>
            
              <li class="nav-article">
                <a href="../connect-from-sqla-to-mysqldb/">Docker Compose で MySQL DB をつくり Compose 外 (非 docker) の SQLAlchemy から接続する</a>
              </li>
            
              <li class="nav-article">
                <a href="../create-django-env-with-docker-compose-mysql-2/">Docker Compose で Django/MySQL 環境をつくる その2</a>
              </li>
            
              <li class="nav-article">
                <a href="./">Docker Compose で Django/MySQL 環境をつくる</a>
              </li>
            
              <li class="nav-article">
                <a href="../use-volumes-with-docker-compose/">Docker Compose で Volumes をつかう</a>
              </li>
            
              <li class="nav-article">
                <a href="../create-django-env-with-docker-compose/">Docker Compose で Django/PostgreSQL 環境をつくる</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_git.html">git</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../git/command/merge/">git merge</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/rebase-i/">git rebase -i</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/rebase/">git rebase</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/note/">Git のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/configuration/">Git の設定まとめ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../git/command/">Git のコマンドまとめ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_github.html">github</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../github/how-to-create-new-repository/">GitHub に新しいリポジトリを作成して、pushする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../github/github-pages-custom-domain-setting/">GitHub Pages にカスタムドメインを設定する</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_mac.html">mac</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../mac/note/">Mac のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_miyadaiku.html">miyadaiku</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../miyadaiku/build/">Miyadaiku ビルドするときのコマンド</a>
              </li>
            
              <li class="nav-article">
                <a href="../../miyadaiku/article-directory-structure/">article の置きかた</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_pycharm.html">pycharm</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../pycharm/django-support/">Pycharm の Django support を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/add-psql-var-to-user-params-for-db-console/">PyCharm の Database Console で PostgreSQL のプレースホルダー (インタポレーション) を SQL パラメーターとして使えるようにする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/connect-db-using-ssh-tunnel/">PyCharm で SSH tunnel して Amazon Redshift につなぐ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/useful-menu-and-shortcuts/">PyCharm ショートカットと便利メニュー</a>
              </li>
            
              <li class="nav-article">
                <a href="../../pycharm/configuration/">PyCharm の設定</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_python.html">python</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../python/etc/">Python いろいろメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python/note/">Python のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python/pyconjp2018/">PyConJP 2018 で聞いた講演</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_redshift.html">redshift</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../redshift/note/">Redshift のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sample.html">sample</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../2018/sample-table/">table の sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../2018/sample-h1-h2-h3-li/">h1, h2, h3, リストの sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../2018/sample-code-block/">code-block, 引用の sample</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sql.html">sql</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../sql/note/">SQL のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_ssh.html">ssh</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../ssh/command/ssh-keygen/">ssh-keygen</a>
              </li>
            
              <li class="nav-article">
                <a href="../../ssh/command/ssh-add/">ssh-add</a>
              </li>
            
              <li class="nav-article">
                <a href="../../ssh/command/ssh/">ssh のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_test.html">test</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../python-test/tox/">tox</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python-test/mypy/">mypy</a>
              </li>
            
              <li class="nav-article">
                <a href="../../python-test/note/">Python テストのメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vagrant.html">vagrant</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../vagrant/note/">Vagrant のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vim.html">vim</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../vim/command/">Vim のコマンド</a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </nav>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-docker">
    <time class="date" datetime="2019-01-05 00:00:00+09:00">
      2019-01-05 Sat
    </time>
    <div class="title">Docker Compose で Django/MySQL 環境をつくる</div>
    <div class="category">
      <a href="/index_category_category_docker.html">
          docker
      </a>
    </div>
    <div class="text">
      <details>
<summary>目次</summary><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id11">リファレンス・ガイド</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id12">環境構築</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id13">最初の1回だけ実行</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id14">2回目以降</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id15">設定ファイル</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id16">ディレクトリ構成</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id17">使い方メモ</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id18">イメージビルドからやり直したい</a></p></li>
<li><p><a class="reference internal" href="#volume" id="id19">volume は消さない限り再利用される</a></p></li>
<li><p><a class="reference internal" href="#web" id="id20">web のほうのコンテナだけ再起動したいとき</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id21">web のほうのコンテナに入る</a></p></li>
<li><p><a class="reference internal" href="#mysql" id="id22">mysql のほうのコンテナに入る</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id23">mysql に入る</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#todo" id="id24">TODO</a></p></li>
</ul>
</div>
</details><div class="section" id="id1">
<div class="md_header_block" id="h_%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9%E3%82%AC%E3%82%A4%E3%83%89"><a class="md_header_anchor" id="a_%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9%E3%82%AC%E3%82%A4%E3%83%89"></a><h1><a class="toc-backref" href="#id11">リファレンス・ガイド</a></h1></div>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.docker.com/compose/compose-file/">Compose file version 3 reference</a></p></li>
<li><p><a class="reference external" href="https://hub.docker.com/_/mysql/">Docker Hub の MySQL 公式イメージぺージ</a></p>
<ul>
<li><p><span class="docutils literal"><span class="pre">docker-compose</span></span> ファイルの書き方見本とか、 Environment Variables の一覧とかが載っていた</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/">MySQL 8.0 Reference Manual</a></p>
<ul>
<li><p>MySQL 自体のリファレンス</p></li>
<li><p><a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/environment-variables.html">MySQL Program Environment Variables</a> :
<span class="docutils literal"><span class="pre">docker-compose</span></span> ファイルの <span class="docutils literal">environment</span> 部分に書けるやつを探すときに使った</p></li>
<li><p><a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/server-options.html">Server Command Options</a> :
<span class="docutils literal">mysql.cnf</span> に書けるやつ、 <span class="docutils literal"><span class="pre">docker-compose</span></span> ファイルの <span class="docutils literal">command</span> 部分に書けるやつを探すときに使った</p></li>
<li><p><a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html">Server System Variables</a> :
<span class="docutils literal">mysql.cnf</span> に書けるやつを探すときに使った</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://pypi.org/project/mysql-connector-python/">PyPI の mysql-connector-python のページ</a></p>
<ul>
<li><p>MySQL の driver。これが Oracle 純正のものらしい。</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://dev.mysql.com/doc/connector-python/en/">MySQL Connector/Python Developer Guide</a></p>
<ul>
<li><p>mysql-connector-python のガイドページ。使い方や見本がいろいろ載っている。</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://pypi.org/project/mysqlclient/">PyPI の mysqlclient のページ</a></p></li>
<li><p><a class="reference external" href="https://docs.djangoproject.com/ja/2.1/ref/databases/#mysql-notes">Django で MySQL を使うときは見てねページ</a></p>
<ul>
<li><p>Django のほうの説明を読んだら、 <span class="docutils literal">mysqlclient</span> がおすすめ、かつ、 <cite>Django requires mysqlclient 1.3.7 or later.</cite> と書いてある。</p></li>
<li><p>とりあえず <span class="docutils literal">mysqlclient</span> と <span class="docutils literal"><span class="pre">mysql-connector-python</span></span> を両方入れてみる。</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<div class="md_header_block" id="h_%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"><a class="md_header_anchor" id="a_%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89"></a><h1><a class="toc-backref" href="#id12">環境構築</a></h1></div>
<div class="section" id="id3">
<div class="md_header_block" id="h_%E6%9C%80%E5%88%9D%E3%81%AE1%E5%9B%9E%E3%81%A0%E3%81%91%E5%AE%9F%E8%A1%8C"><a class="md_header_anchor" id="a_%E6%9C%80%E5%88%9D%E3%81%AE1%E5%9B%9E%E3%81%A0%E3%81%91%E5%AE%9F%E8%A1%8C"></a><h2><a class="toc-backref" href="#id13">最初の1回だけ実行</a></h2></div>
<ol class="arabic">
<li><p>web・db の docker image をビルド -&gt; web で startproject する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose --pull<span class="o">=</span><span class="nb">true</span> run web django-admin.py startproject fu .
</pre></div>
</div>
<ul class="simple">
<li><p><span class="docutils literal"><span class="pre">--pull=true</span></span> : FROM に指定したベースイメージがローカルにすでに存在していても、改めて Docker Hub に取得しにいく</p></li>
<li><p>↑今やったら使えなかった。最新イメージを再取得するには、どうすればいいんだろう。</p></li>
</ul>
</blockquote>
</li>
<li><p>settings に MySQL の設定を書き足す</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'ENGINE'</span><span class="p">:</span> <span class="s1">'django.db.backends.mysql'</span><span class="p">,</span>
        <span class="s1">'NAME'</span><span class="p">:</span> <span class="s1">'fu'</span><span class="p">,</span>
        <span class="s1">'USER'</span><span class="p">:</span> <span class="s1">'fu'</span><span class="p">,</span>
        <span class="s1">'PASSWORD'</span><span class="p">:</span> <span class="s1">'fu'</span><span class="p">,</span>
        <span class="s1">'HOST'</span><span class="p">:</span> <span class="s1">'db'</span><span class="p">,</span>
        <span class="s1">'PORT'</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>docker-compose up して、 web・db コンテナを起動する</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose up
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id4">
<div class="md_header_block" id="h_2%E5%9B%9E%E7%9B%AE%E4%BB%A5%E9%99%8D"><a class="md_header_anchor" id="a_2%E5%9B%9E%E7%9B%AE%E4%BB%A5%E9%99%8D"></a><h2><a class="toc-backref" href="#id14">2回目以降</a></h2></div>
<ol class="arabic">
<li><p>docker-compose up して mysql・web コンテナを起動する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose up
</pre></div>
</div>
</blockquote>
</li>
<li><p>安全にシャットダウン。コンテナの停止と削除。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose down
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="id5">
<span id="config-files"></span><div class="md_header_block" id="h_%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><a class="md_header_anchor" id="a_%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"></a><h2><a class="toc-backref" href="#id15">設定ファイル</a></h2></div>
<ul>
<li><p>fu/docker-compose.yml</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">'3'</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu_db</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile-mysql</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">"db-data:/var/lib/mysql"</span>
      <span class="c1"># mysql のカスタム設定ファイルもホスト &lt;-&gt; コンテナ間で同期しておく (編集するのに便利だから)</span>
      <span class="p p-Indicator">-</span> <span class="s">"./mysql/conf.d:/etc/mysql/conf.d"</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu</span>
      <span class="nt">MYSQL_DATABASE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu</span>
      <span class="nt">MYSQL_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu</span>
      <span class="nt">MYSQL_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu</span>

  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fu_web</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile-web</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3 manage.py runserver 0.0.0.0:8000 --settings=settings._</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">.:/code</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">"3236:8000"</span>
    <span class="nt">depends_on</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">db-data</span><span class="p">:</span>
</pre></div>
</div>
</li>
<li><p>fu/Dockerfile-web</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> python:3</span>
<span class="k">ENV</span> PYTHONUNBUFFERED <span class="m">1</span>
<span class="k">RUN</span> mkdir /code
<span class="k">WORKDIR</span><span class="s"> /code</span>
<span class="k">ADD</span> requirements.txt /code/
<span class="k">RUN</span> pip install -r requirements.txt
<span class="k">ADD</span> . /code/
</pre></div>
</div>
</li>
<li><p>fu/Dockerfile-mysql</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> mysql:latest</span>
<span class="c"># locales をインストールする</span>
<span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y locales locales-all
<span class="c"># locale 定義ファイルをコンパイルする</span>
<span class="k">RUN</span> locale-gen ja_JP.UTF-8
<span class="c"># 日本語を設定する TODO: もしかして LANG だけでいいのかも...?</span>
<span class="k">ENV</span> LANG ja_JP.UTF-8
<span class="k">ENV</span> LANGUAGE ja_JP:en
<span class="k">ENV</span> LC_ALL ja_JP.UTF-8
<span class="c"># タイムゾーンに日本を設定する</span>
<span class="k">RUN</span> ln -sf /usr/share/zoneinfo/Japan /etc/localtime
</pre></div>
</div>
</li>
<li><p>fu/requirements.txt</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="n">Django</span><span class="o">&gt;=</span><span class="mf">1.11</span>
<span class="n">mysqlclient</span><span class="o">&gt;=</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">7</span>
<span class="n">mysql</span><span class="o">-</span><span class="n">connector</span><span class="o">-</span><span class="n">python</span>
</pre></div>
</div>
</li>
<li><p>fu/mysql/conf.d/mysql.cnf</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="na">[mysqld]  # mysqlサーバーの設定</span>
<span class="na">default-authentication-plugin</span><span class="o">=</span><span class="s">mysql_native_password</span>
<span class="c1"># Collation (文字照合順) の設定: https://mysqlserverteam.com/mysql-8-0-kana-sensitive-collation-for-japanese-ja_jp/</span>
<span class="na">collation-server</span><span class="o">=</span><span class="s">utf8mb4_ja_0900_as_cs_ks</span>
<span class="c1"># サーバー側の文字コードの設定: "Default Value (&gt;= 8.0.1) utf8mb4" だけれどもなんとなく念のため指定</span>
<span class="na">character-set-server</span><span class="o">=</span><span class="s">utf8mb4</span>
<span class="c1"># time_zone の設定: https://dev.mysql.com/doc/refman/8.0/en/server-options.html#option_mysqld_default-time-zone</span>
<span class="na">default-time-zone</span><span class="o">=</span><span class="s">'Asia/Tokyo'</span>

<span class="na">[client]  # mysqlクライアントの設定</span>
<span class="c1"># クライアント側の文字コードの設定</span>
<span class="c1"># utf8mb4: A UTF-8 encoding of the Unicode character set using one to four bytes per character.</span>
<span class="na">default-character-set</span><span class="o">=</span><span class="s">utf8mb4</span>
</pre></div>
</div>
<ul>
<li><p>MySQL デフォルトの設定ファイルは <span class="docutils literal">/etc/mysql/my.cnf</span> の模様。 MySQL 公式イメージからコンテナを作成すると、初期状態で <span class="docutils literal">/etc/mysql/my.cnf</span> 中に</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># Custom config should go here</span>
<span class="na">!includedir /etc/mysql/conf.d/</span>
</pre></div>
</div>
<p>と書いてあるので、言に従い自分用設定は <span class="docutils literal">/etc/mysql/conf.d/</span> に記述した。</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id6">
<div class="md_header_block" id="h_%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90"><a class="md_header_anchor" id="a_%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90"></a><h2><a class="toc-backref" href="#id16">ディレクトリ構成</a></h2></div>
<div class="code-block">
<div class="highlight"><pre><span></span>$ tree fu

fu
├── Dockerfile-mysql
├── Dockerfile-web
├── docker-compose.yml
├── fu
│   ├── __init__.py
│   ├── urls.py
│   └── wsgi.py
├── manage.py
├── mysql
│   └── conf.d
│       └── mysql.cnf
├── requirements.txt
└── settings
    └── _.py
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<div class="md_header_block" id="h_%E4%BD%BF%E3%81%84%E6%96%B9%E3%83%A1%E3%83%A2"><a class="md_header_anchor" id="a_%E4%BD%BF%E3%81%84%E6%96%B9%E3%83%A1%E3%83%A2"></a><h1><a class="toc-backref" href="#id17">使い方メモ</a></h1></div>
<div class="section" id="id8">
<div class="md_header_block" id="h_%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%93%E3%83%AB%E3%83%89%E3%81%8B%E3%82%89%E3%82%84%E3%82%8A%E7%9B%B4%E3%81%97%E3%81%9F%E3%81%84"><a class="md_header_anchor" id="a_%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%83%93%E3%83%AB%E3%83%89%E3%81%8B%E3%82%89%E3%82%84%E3%82%8A%E7%9B%B4%E3%81%97%E3%81%9F%E3%81%84"></a><h2><a class="toc-backref" href="#id18">イメージビルドからやり直したい</a></h2></div>
<p>こんなときは...</p>
<ul class="simple">
<li><p>requirements.txt にライブラリを書き足したとき</p></li>
<li><p>Dockerfile を更新したとき</p></li>
</ul>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose build
$ docker-compose up
</pre></div>
</div>
<p>もしくは、</p>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker-compose up --build
</pre></div>
</div>
</div>
<div class="section" id="volume">
<div class="md_header_block" id="h_volume%E3%81%AF%E6%B6%88%E3%81%95%E3%81%AA%E3%81%84%E9%99%90%E3%82%8A%E5%86%8D%E5%88%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B"><a class="md_header_anchor" id="a_volume%E3%81%AF%E6%B6%88%E3%81%95%E3%81%AA%E3%81%84%E9%99%90%E3%82%8A%E5%86%8D%E5%88%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B"></a><h2><a class="toc-backref" href="#id19">volume は消さない限り再利用される</a></h2></div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># fu/docker-compose.yml</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">db-data</span><span class="p">:</span>
</pre></div>
</div>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker volume ls
DRIVER              VOLUME NAME
<span class="nb">local</span>               fu_db-data  <span class="c1"># こういう名前がついている</span>
</pre></div>
</div>
</div>
<div class="section" id="web">
<div class="md_header_block" id="h_web%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%A0%E3%81%91%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D"><a class="md_header_anchor" id="a_web%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%A0%E3%81%91%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D"></a><h2><a class="toc-backref" href="#id20">web のほうのコンテナだけ再起動したいとき</a></h2></div>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker container restart fu_web
</pre></div>
</div>
</div>
<div class="section" id="id9">
<div class="md_header_block" id="h_web%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E5%85%A5%E3%82%8B"><a class="md_header_anchor" id="a_web%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E5%85%A5%E3%82%8B"></a><h2><a class="toc-backref" href="#id21">web のほうのコンテナに入る</a></h2></div>
<p>VM の中に入るのと同じような気持ち。</p>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker container <span class="nb">exec</span> -it fu_web bash
root@eb1ab9a6dbdb:/code#

<span class="c1"># 現在のロケール設定を確認する</span>
root@eb1ab9a6dbdb:/code# locale
<span class="nv">LANG</span><span class="o">=</span>C.UTF-8
<span class="nv">LANGUAGE</span><span class="o">=</span>
<span class="nv">LC_CTYPE</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_NUMERIC</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_TIME</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_COLLATE</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_MONETARY</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_MESSAGES</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_PAPER</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_NAME</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_ADDRESS</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_TELEPHONE</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_MEASUREMENT</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_IDENTIFICATION</span><span class="o">=</span><span class="s2">"C.UTF-8"</span>
<span class="nv">LC_ALL</span><span class="o">=</span>
</pre></div>
</div>
</div>
<div class="section" id="mysql">
<div class="md_header_block" id="h_mysql%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E5%85%A5%E3%82%8B"><a class="md_header_anchor" id="a_mysql%E3%81%AE%E3%81%BB%E3%81%86%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E5%85%A5%E3%82%8B"></a><h2><a class="toc-backref" href="#id22">mysql のほうのコンテナに入る</a></h2></div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># mysql のコンテナに入る</span>
$ docker container <span class="nb">exec</span> -it fu_db bash

<span class="c1"># 現在のロケール設定を確認する</span>
root@dcc8b4d2cd21:/# locale
<span class="nv">LANG</span><span class="o">=</span>ja_JP.UTF-8
<span class="nv">LANGUAGE</span><span class="o">=</span>ja_JP:en
<span class="nv">LC_CTYPE</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_NUMERIC</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_TIME</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_COLLATE</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_MONETARY</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_MESSAGES</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_PAPER</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_NAME</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_ADDRESS</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_TELEPHONE</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_MEASUREMENT</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_IDENTIFICATION</span><span class="o">=</span><span class="s2">"ja_JP.UTF-8"</span>
<span class="nv">LC_ALL</span><span class="o">=</span>ja_JP.UTF-8
</pre></div>
</div>
</div>
<div class="section" id="id10">
<div class="md_header_block" id="h_mysql%E3%81%AB%E5%85%A5%E3%82%8B"><a class="md_header_anchor" id="a_mysql%E3%81%AB%E5%85%A5%E3%82%8B"></a><h2><a class="toc-backref" href="#id23">mysql に入る</a></h2></div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># mysql のコンテナに入る</span>
$ docker container <span class="nb">exec</span> -it fu_db bash
root@6ba1661872de:/#

<span class="c1"># mysql にログインする</span>
$ mysql -h localhost -u fu -p fu

Enter password: <span class="o">(</span>compose ファイルに定義したパスワード<span class="o">)</span>

<span class="c1"># 現在の Character Sets 設定を表示する</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s2">"char%"</span><span class="p">;</span>
+--------------------------+--------------------------------+
<span class="p">|</span> Variable_name            <span class="p">|</span> Value                          <span class="p">|</span>
+--------------------------+--------------------------------+
<span class="p">|</span> character_set_client     <span class="p">|</span> utf8mb4                        <span class="p">|</span>
<span class="p">|</span> character_set_connection <span class="p">|</span> utf8mb4                        <span class="p">|</span>
<span class="p">|</span> character_set_database   <span class="p">|</span> utf8mb4                        <span class="p">|</span>
<span class="p">|</span> character_set_filesystem <span class="p">|</span> binary                         <span class="p">|</span>
<span class="p">|</span> character_set_results    <span class="p">|</span> utf8mb4                        <span class="p">|</span>
<span class="p">|</span> character_set_server     <span class="p">|</span> utf8mb4                        <span class="p">|</span>
<span class="p">|</span> character_set_system     <span class="p">|</span> utf8                           <span class="p">|</span>
<span class="p">|</span> character_sets_dir       <span class="p">|</span> /usr/share/mysql-8.0/charsets/ <span class="p">|</span>
+--------------------------+--------------------------------+
<span class="m">8</span> rows in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.01 sec<span class="o">)</span>

<span class="c1"># 現在のタイムゾーン設定を表示する</span>
mysql&gt; SHOW VARIABLES LIKE <span class="s1">'%time_zone%'</span><span class="p">;</span>
+------------------+------------+
<span class="p">|</span> Variable_name    <span class="p">|</span> Value      <span class="p">|</span>
+------------------+------------+
<span class="p">|</span> system_time_zone <span class="p">|</span> JST        <span class="p">|</span>  <span class="c1"># MySQL が動いているコンテナ (Debian) のシステムタイムゾーン、Dockerfile-mysql で設定した</span>
<span class="p">|</span> time_zone        <span class="p">|</span> Asia/Tokyo <span class="p">|</span>  <span class="c1"># mysql.cnf で設定した MySQL サーバー側のタイムゾーン</span>
+------------------+------------+
<span class="m">2</span> rows in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.01 sec<span class="o">)</span>

mysql&gt; status
--------------
mysql  Ver <span class="m">8</span>.0.13 <span class="k">for</span> Linux on x86_64 <span class="o">(</span>MySQL Community Server - GPL<span class="o">)</span>

Connection id:                <span class="m">11</span>
Current database:     fu
Current user:         fu@localhost
SSL:                  Not in use
Current pager:                stdout
Using outfile:                <span class="s1">''</span>
Using delimiter:      <span class="p">;</span>
Server version:               <span class="m">8</span>.0.13 MySQL Community Server - GPL
Protocol version:     <span class="m">10</span>
Connection:           Localhost via UNIX socket
Server characterset:  utf8mb4
Db     characterset:  utf8mb4
Client characterset:  utf8mb4
Conn.  characterset:  utf8mb4
UNIX socket:          /var/run/mysqld/mysqld.sock
Uptime:                       <span class="m">2</span> hours <span class="m">9</span> min <span class="m">49</span> sec

Threads: <span class="m">3</span>  Questions: <span class="m">40</span>  Slow queries: <span class="m">0</span>  Opens: <span class="m">189</span>  Flush tables: <span class="m">2</span>  Open tables: <span class="m">163</span>  Queries per second avg: <span class="m">0</span>.005
--------------
</pre></div>
</div>
</div>
</div>
<div class="section" id="todo">
<div class="md_header_block" id="h_TODO"><a class="md_header_anchor" id="a_TODO"></a><h1><a class="toc-backref" href="#id24">TODO</a></h1></div>
<p>web コンテナのほうの locale と タイムゾーンは db コンテナと合わせなくて大丈夫なんだろうか...</p>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>

</html>