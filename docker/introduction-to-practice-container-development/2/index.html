<!DOCTYPE html>
<html lang="ja-JP">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Docker/Kubernetes 実践コンテナ開発入門 --- 2. Docker コンテナのデプロイ/32imuf.com</title>
    <link rel="shortcut icon" href="/static/icons/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Griffy">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/sawarabimincho.css"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/style.css?20181123">
  </head>

  <body>
    <div class="container">
      <div class="header"><header class="item item-header">
  <h1>
    <a href="/">
      <img class="logo" src="/static/images/inuu.png" alt="犬">
    </a>
  </h1>
  <nav class="nav">
    <ul>
      <li class="nav-category"><a href="/">HOME</a></li>
      
      
        
        <li class="nav-category">
          <a href="/index_category_category_aws.html">aws</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../aws/what-is-amazon-aurora/">Amazon Aurora とはなんですか？</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../aws/s3-response-error/">S3ResponseError の原因はなんと時刻ずれだった</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_blog.html">blog</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../blog/rules/">ブログを書くときの注意点</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_css.html">css</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../html-css/css/note/">CSS のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../html-css/configure-stylus-output-directory/">PyCharm の File Watcher で、 Stylus の CSS ファイル生成先ディレクトリを指定する。</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../html-css/stylus/">Stylus を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../html-css/html5-css3-modern-coding/">『HTML5/CSS3モダンコーディング フロントエンドエンジニアが教える3つの本格レイアウト スタンダード・グリッド・シングルページレイアウトの作り方』を読んで気になったことメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_django.html">django</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../django/note/">Django のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../django/django_orm/">Django ORM のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_docker.html">docker</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../use-volumes-with-docker-compose/">Docker Compose で Volumes をつかう</a>
              </li>
            
              <li class="nav-article">
                <a href="../../create-django-env-with-docker-compose/">Docker Compose で Django 環境をつくる</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_git.html">git</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../git/command/merge/">git merge</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../git/command/rebase-i/">git rebase -i</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../git/command/rebase/">git rebase</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../git/note/">Git のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../git/configuration/">Git の設定まとめ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../git/command/">Git のコマンドまとめ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_github.html">github</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../github/how-to-create-new-repository/">GitHub に新しいリポジトリを作成して、pushする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../github/github-pages-custom-domain-setting/">GitHub Pages にカスタムドメインを設定する</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_mac.html">mac</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../mac/note/">Mac のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_miyadaiku.html">miyadaiku</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../miyadaiku/build/">Miyadaiku ビルドするときのコマンド</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../miyadaiku/article-directory-structure/">article の置きかた</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_pycharm.html">pycharm</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../pycharm/django-support/">Pycharm の Django support を使う</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../pycharm/add-psql-var-to-user-params-for-db-console/">PyCharm の Database Console で PostgreSQL のプレースホルダー (インタポレーション) を SQL パラメーターとして使えるようにする</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../pycharm/connect-db-using-ssh-tunnel/">PyCharm で SSH tunnel して Amazon Redshift につなぐ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../pycharm/useful-menu-and-shortcuts/">PyCharm ショートカットと便利メニュー</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../pycharm/configuration/">PyCharm の設定</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_python.html">python</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../python/etc/">Python いろいろメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../python/note/">Python のメモ</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../python/pyconjp2018/">PyConJP 2018 で聞いた講演</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_redshift.html">redshift</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../redshift/note/">Redshift のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sample.html">sample</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../2018/sample-table/">table の sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../2018/sample-h1-h2-h3-li/">h1, h2, h3, リストの sample</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../2018/sample-code-block/">code-block, 引用の sample</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_sql.html">sql</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../sql/note/">SQL のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_ssh.html">ssh</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../ssh/command/ssh-keygen/">ssh-keygen</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../ssh/command/ssh-add/">ssh-add</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../ssh/command/ssh/">ssh のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_test.html">test</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../python-test/tox/">tox</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../python-test/mypy/">mypy</a>
              </li>
            
              <li class="nav-article">
                <a href="../../../python-test/note/">Python テストのメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vagrant.html">vagrant</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../vagrant/note/">Vagrant のメモ</a>
              </li>
            
          </ul>
        </li>
      
        
        <li class="nav-category">
          <a href="/index_category_category_vim.html">vim</a>
          <ul>
            
              <li class="nav-article">
                <a href="../../../vim/command/">Vim のコマンド</a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </nav>
</header></div>
      <div class="main">
<div class="article-content">
  <main class="item item-article item-docker">
    <time class="date" datetime="2018-11-04 00:00:00+09:00">
      2018-11-04 Sun
    </time>
    <div class="title">Docker/Kubernetes 実践コンテナ開発入門 --- 2. Docker コンテナのデプロイ</div>
    <div class="category">
      <a href="/index_category_category_docker.html">
          docker
      </a>
    </div>
    <div class="text">
      <details>
<summary>目次</summary><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id26">2.1 コンテナでアプリケーションを実行する</a></p>
<ul>
<li><p><a class="reference internal" href="#docker-docker" id="id27">2.1.1 Docker イメージと Docker コンテナの基本</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id28">基本の流れ</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id3" id="id29">2.1.2 簡単なアプリケーションと Docker イメージをつくる</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id30">用意するもの</a></p></li>
<li><p><a class="reference internal" href="#dockerfile" id="id31">Dockerfileの説明</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id32">Docker イメージをビルドする</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id6" id="id33">2.1.3 Docker コンテナを実行する</a></p>
<ul>
<li><p><a class="reference internal" href="#id7" id="id34">ポートフォワーディング</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id8" id="id35">2.2 Docker イメージの操作</a></p>
<ul>
<li><p><a class="reference internal" href="#docker-image-build" id="id36">2.2.1 docker image build --- イメージのビルド</a></p></li>
<li><p><a class="reference internal" href="#docker-search" id="id37">2.2.2 docker search --- イメージの検索</a></p>
<ul>
<li><p><a class="reference internal" href="#docker-hub" id="id38">Docker Hub</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id39">検索する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-image-pull" id="id40">2.2.3 docker image pull --- イメージの取得</a></p></li>
<li><p><a class="reference internal" href="#docker-image-ls" id="id41">2.2.4 docker image ls --- イメージの一覧</a></p></li>
<li><p><a class="reference internal" href="#docker-image-tag" id="id42">2.2.5 docker image tag --- イメージのタグ付け</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id43">Docker イメージのバージョン</a></p></li>
<li><p><a class="reference internal" href="#id" id="id44">イメージIDへのタグ付け</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-image-push" id="id45">2.2.6 docker image push --- イメージの公開</a></p>
<ul>
<li><p><a class="reference internal" href="#docker-hub-push" id="id46">Docker Hub にイメージを push する</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id11" id="id47">2.3 Docker コンテナの操作</a></p>
<ul>
<li><p><a class="reference internal" href="#id12" id="id48">2.3.1 Docker コンテナのライフサイクル</a></p></li>
<li><p><a class="reference internal" href="#docker-container-run" id="id49">2.3.2 docker container run --- コンテナの作成と実行</a></p>
<ul>
<li><p><a class="reference internal" href="#id13" id="id50">docker container run 時に引数を与える</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id51">名前付きコンテナ</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id52">コマンド実行時の頻出オプション</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-container-ls" id="id53">2.3.3 docker container ls --- コンテナの一覧</a></p>
<ul>
<li><p><a class="reference internal" href="#id16" id="id54">コンテナIDだけを抽出する</a></p></li>
<li><p><a class="reference internal" href="#filter" id="id55">filter を使う</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id56">終了したコンテナを取得する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-container-stop" id="id57">2.3.4 docker container stop --- コンテナの停止</a></p></li>
<li><p><a class="reference internal" href="#docker-container-restart" id="id58">2.3.5 docker container restart --- コンテナの再起動</a></p></li>
<li><p><a class="reference internal" href="#docker-container-rm" id="id59">2.3.6 docker container rm --- コンテナの破棄</a></p>
<ul>
<li><p><a class="reference internal" href="#id18" id="id60">停止の際にコンテナを破棄する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-container-logs" id="id61">2.3.7 docker container logs --- 標準出力の取得</a></p></li>
<li><p><a class="reference internal" href="#docker-container-exec" id="id62">2.3.8 docker container exec --- 実行中コンテナでのコマンド実行</a></p></li>
<li><p><a class="reference internal" href="#docker-container-cp" id="id63">2.3.9 docker container cp --- ファイルのコピー</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id19" id="id64">2.4 運用管理向けコマンド</a></p>
<ul>
<li><p><a class="reference internal" href="#prune" id="id65">2.4.1 prune --- 破棄</a></p>
<ul>
<li><p><a class="reference internal" href="#id20" id="id66">Docker イメージを一括削除する</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id67">Docker リソースを一括削除する</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-container-stats" id="id68">2.4.2 docker container stats --- 利用状況の取得</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#docker-compose" id="id69">2.5 Docker Compose でマルチコンテナを実行する</a></p>
<ul>
<li><p><a class="reference internal" href="#id22" id="id70">2.5.1 docker-compose によるコンテナの実行</a></p>
<ul>
<li><p><a class="reference internal" href="#id23" id="id71">使えるかどうか確認する</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id72">docker-compose でコンテナを実行する</a></p></li>
<li><p><a class="reference internal" href="#docker-compose-docker" id="id73">docker-compose で Docker イメージをビルドして、そのまま実行する</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#compose" id="id74">2.6 Compose による複数コンテナの実行</a></p>
<ul>
<li><p><a class="reference internal" href="#jenkins" id="id75">2.6.1 Jenkins コンテナを実行する</a></p></li>
<li><p><a class="reference internal" href="#master-jenkins-ssh" id="id76">2.6.2 Master Jenkins の SSH 鍵を作る</a></p></li>
<li><p><a class="reference internal" href="#jenkins-slave" id="id77">2.6.3 Jenkins Slave コンテナを作る</a></p>
<ul>
<li><p><a class="reference internal" href="#id25" id="id78">参考サイト</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details><div class="section" id="id1">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_1"></div><h1><a class="toc-backref" href="#id26">2.1 コンテナでアプリケーションを実行する</a></h1>
<table class="colwidths-auto">
<caption>Docker イメージと Docker コンテナの関係性</caption>
<thead>
<tr><th class="head"><p>名称</p></th>
<th class="head"><p>役割</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>Docker イメージ</p></td>
<td><ul class="simple">
<li><p>Docker コンテナを構成するファイルシステムや、実行するアプリケーションや設定をまとめたもの</p></li>
<li><p>コンテナを作成するために利用されるテンプレートとなるもの</p></li>
</ul>
</td>
</tr>
<tr><td><p>Docker コンテナ</p></td>
<td><ul class="simple">
<li><p>Docker イメージを基に作成され、具現化されたファイルシステムとアプリケーションが実行されている状態</p></li>
<li><p>ひとつの Docker イメージから複数のコンテナを生成できる</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>まずは、イメージから作成する</p></li>
</ul>
<div class="section" id="docker-docker">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_2"></div><h2><a class="toc-backref" href="#id27">2.1.1 Docker イメージと Docker コンテナの基本</a></h2>
<div class="section" id="id2">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_3"></div><h3><a class="toc-backref" href="#id28">基本の流れ</a></h3>
<ol class="arabic">
<li><p>Docker イメージをダウンロード</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker image pull gihyodocker/echo:latest
<span class="go">latest: Pulling from gihyodocker/echo</span>
<span class="go">723254a2c089: Pull complete</span>
<span class="go">abe15a44e12f: Pull complete</span>
<span class="go">409a28e3cc3d: Pull complete</span>
<span class="go">503166935590: Pull complete</span>
<span class="go">abe52c89597f: Pull complete</span>
<span class="go">ce145c5cf4da: Pull complete</span>
<span class="go">96e333289084: Pull complete</span>
<span class="go">39cd5f38ffb8: Pull complete</span>
<span class="go">22860d04f4f1: Pull complete</span>
<span class="go">7528760e0a03: Pull complete</span>
<span class="go">Digest: sha256:4520b6a66d2659dea2f8be5245eafd5434c954485c6c1ac882c56927fe4cec84</span>
<span class="go">Status: Downloaded newer image for gihyodocker/echo:latest</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>Docker イメージを実行</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker container run -t -p <span class="m">9000</span>:8080 gihyodocker/echo:latest
<span class="go">2018/10/01 13:53:03 start server</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ポートフォワーディング設定をしている</p>
<ul>
<li><p>Docker 実行環境の 9000 ポート経由で HTTP リクエストを受けられるようになっている</p></li>
</ul>
</li>
</ul>
</blockquote>
</li>
<li><p>別のターミナルからアクセスしてみる</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">FumienoMacBook-Pro:~ fumi23$</span> curl http://localhost:9000
<span class="go">Hello Docker!!</span>
</pre></div>
</div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">FumienoMacBook-Pro:docker-work fumi23$</span> docker container run -t -p <span class="m">9000</span>:8080 gihyodocker/echo:latest
<span class="go">2018/10/01 13:53:03 start server</span>
<span class="go">2018/10/01 13:56:44 received request</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>停止する</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker stop <span class="k">$(</span>docker container ls -q<span class="k">)</span>
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="id3">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_4"></div><h2><a class="toc-backref" href="#id29">2.1.2 簡単なアプリケーションと Docker イメージをつくる</a></h2>
<p>Docker コンテナがどのように作られ、実行されているかのイメージをつかむ。
Go 言語で簡単な Web サーバーを書き、 Docker コンテナ嬢で動作させてみましょう。</p>
<div class="section" id="id4">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_5"></div><h3><a class="toc-backref" href="#id30">用意するもの</a></h3>
<ul>
<li><p>main.go</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"received request"</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"Hello Docker!!"</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"start server"</span><span class="p">)</span>
    <span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="s">":8080"</span><span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Dockerfile</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> golang:1.9</span>

<span class="k">RUN</span> mkdir /echo
COPY main.go /echo

<span class="k">CMD</span><span class="s"> ["go", "run", "/echo/main.go"]</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="dockerfile">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_6"></div><h3><a class="toc-backref" href="#id31">Dockerfileの説明</a></h3>
<ul>
<li><p>Dockerfile には、 Docker 独自の DSL (ドメイン固有言語) を使ってイメージの構成を定義する。</p></li>
<li><p><span class="docutils literal">FROM</span> や <span class="docutils literal">RUN</span> といったキーワードは「インストラクション (命令) 」と呼ばれている。</p>
<table class="colwidths-auto">
<caption>Dockerfile のインストラクション</caption>
<thead>
<tr><th class="head"><p>インストラクション名</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>FROM</p></td>
<td><ul class="simple">
<li><p>作成する Docker イメージのベースとなるイメージを指定する。</p></li>
<li><p>Dockerfile でイメージをビルドする際、まず最初に <span class="docutils literal">FROM</span> で指定されたイメージをダウンロードしてから実行される。</p></li>
<li><p>Docker は、デフォルトで <span class="docutils literal">FROM</span> の取得先として <span class="docutils literal">Docker Hub</span> のレジストリを参照する。</p></li>
</ul>
</td>
</tr>
<tr><td><p>RUN</p></td>
<td><ul class="simple">
<li><p>Docker イメージビルド時に、 Docker コンテナで実行するコマンドを定義します。</p></li>
<li><p><span class="docutils literal">RUN</span> の引数には Docker コンテナ内で実行するコマンドをそのまま指定する。</p></li>
</ul>
</td>
</tr>
<tr><td><p>COPY</p></td>
<td><p>Docker を動作させているホストマシン上のファイルやディレクトリを Docker コンテナ内にコピーするためのインストラクション。</p></td>
</tr>
<tr><td><p>CMD</p></td>
<td><ul class="simple">
<li><p>Docker コンテナとして実行する際に、コンテナ内で実行するプロセスを指定する。</p></li>
<li><p><span class="docutils literal">CMD</span> はコンテナ起動時に１度実行される。</p></li>
<li><p><span class="docutils literal">CMD</span> で指定した命令は、 docker container run の指定で実行時に上書きできる。</p></li>
</ul>
</td>
</tr>
<tr><td><p>LABEL</p></td>
<td><p>イメージの作者名記入などに使う。</p></td>
</tr>
<tr><td><p>ENV</p></td>
<td><p>Dockerfile をもとに生成した Docker コンテナ内で使える環境変数を指定する。</p></td>
</tr>
<tr><td><p>ARG</p></td>
<td><p>ビルド時に情報を埋め込むために使う。イメージビルドのときだけ使用できる一時的な環境変数。</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="section" id="id5">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_7"></div><h3><a class="toc-backref" href="#id32">Docker イメージをビルドする</a></h3>
<p>Docker イメージを作成するためのコマンド</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image build -t 名前空間/イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre></div>
</div>
<p>実行すると、</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image build -t example/echo:latest .
<span class="go">Sending build context to Docker daemon  3.072kB</span>
<span class="go">Step 1/4 : FROM golang:1.9</span>
<span class="go">1.9: Pulling from library/golang</span>
<span class="go">55cbf04beb70: Pull complete</span>
<span class="go">1607093a898c: Pull complete</span>
<span class="go">9a8ea045c926: Pull complete</span>
<span class="go">d4eee24d4dac: Pull complete</span>
<span class="go">9c35c9787a2f: Pull complete</span>
<span class="go">8b376bbb244f: Pull complete</span>
<span class="go">0d4eafcc732a: Pull complete</span>
<span class="go">186b06a99029: Pull complete</span>
<span class="go">Digest: sha256:8b5968585131604a92af02f5690713efadf029cc8dad53f79280b87a80eb1354</span>
<span class="go">Status: Downloaded newer image for golang:1.9</span>
<span class="go"> ---&gt; ef89ef5c42a9</span>
<span class="go">Step 2/4 : RUN mkdir /echo</span>
<span class="go"> ---&gt; Running in 4da08e7c5693</span>
<span class="go">Removing intermediate container 4da08e7c5693</span>
<span class="go"> ---&gt; 7caf124fb4d3</span>
<span class="go">Step 3/4 : COPY main.go /echo</span>
<span class="go"> ---&gt; 73db87b05d43</span>
<span class="go">Step 4/4 : CMD ["go", "run", "/echo/main.go"]</span>
<span class="go"> ---&gt; Running in 3db24ec2a7c7</span>
<span class="go">Removing intermediate container 3db24ec2a7c7</span>
<span class="go"> ---&gt; 294c33d2b845</span>
<span class="go">Successfully built 294c33d2b845</span>
<span class="go">Successfully tagged example/echo:latest</span>
<span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     latest              294c33d2b845        37 seconds ago      750MB</span>
<span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="docutils literal">ENTRYPOINT</span> というものを使うと、コマンド実行が便利になるらしい</p></li>
</ul>
</div>
</div>
<div class="section" id="id6">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_8"></div><h2><a class="toc-backref" href="#id33">2.1.3 Docker コンテナを実行する</a></h2>
<ul>
<li><p>コンテナを実行する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run example/echo:latest
<span class="go">2018/11/04 10:05:45 start server</span>
</pre></div>
</div>
<ul class="simple">
<li><p>終了は、 <span class="docutils literal">Ctrl + C</span> (やってみたけど終わらないな...)</p></li>
</ul>
</li>
<li><p><span class="docutils literal"><span class="pre">-d</span></span>: バックグランドでコンテナを実行させる</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run -d example/echo:latest
<span class="go">449ccdc8c99e72ecd791b036417632ec3e7944f1e7ab14c5b96d7e4caec0e58b</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ハッシュ値のような文字列は、 Docker コンテナのID</p></li>
<li><p>コンテナのID は、コンテナ実行時に付与される一意な ID</p></li>
</ul>
</li>
<li><p>停止する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container stop <span class="k">$(</span>docker container ls --filter <span class="s2">"ancestor=example/echo"</span> -q<span class="k">)</span>
<span class="go">449ccdc8c99e</span>
</pre></div>
</div>
</li>
<li><p>現在実行中のコンテナの一覧を表示する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS               NAMES</span>
<span class="go">449ccdc8c99e        example/echo:latest   "go run /echo/main.go"   2 minutes ago       Up 2 minutes                            determined_zhukovsky</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id7">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_9"></div><h3><a class="toc-backref" href="#id34">ポートフォワーディング</a></h3>
<p>ホストマシンのポートをコンテナポートに紐づける。
コンテナの外から来た通信をコンテナポートに転送することができる。</p>
<ul>
<li><p>ホスト側の 9000 番ポートをコンテナ側の 8080 番ポートにポートフォワーディングする。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run -d -p <span class="m">9000</span>:8080 example/echo:latest
<span class="go">b113261a42b8fb110cd1984904dccfe859067abd078637ff37804ad5f00c3ff5</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="docutils literal"><span class="pre">-p</span> <span class="pre">{ホスト側ポート}:{コンテナポート}</span></span></p></li>
<li><p>ホスト側のポートは省略できる。省略すると空いているポートが自動的に割り当てられる。</p></li>
</ul>
</li>
<li><p>ホスト側のポートに curl で GET リクエストしてみる</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> curl http://localhost:9000/
<span class="go">Hello Docker!!</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id8">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_10"></div><h1><a class="toc-backref" href="#id35">2.2 Docker イメージの操作</a></h1>
<dl class="field-list simple">
<dt>Docker イメージ</dt>
<dd><p>Docker コンテナを作成するためのテンプレート</p>
</dd>
<dt>Dockerfile</dt>
<dd><p>イメージを構築するための手順を記述したファイル</p>
</dd>
<dt>Docker イメージをビルドする</dt>
<dd><p>イメージを構築する</p>
</dd>
</dl>
<ul>
<li><p>Docker のヘルプを表示する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker <span class="nb">help</span>
</pre></div>
</div>
</li>
<li><p>Docker のイメージ操作に関するコマンドのヘルプを表示する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image --help
</pre></div>
</div>
</li>
</ul>
<div class="section" id="docker-image-build">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_11"></div><h2><a class="toc-backref" href="#id36">2.2.1 docker image build --- イメージのビルド</a></h2>
<ul>
<li><p>Dockerfile をもとに Docker イメージを作成する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image build -t イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre></div>
</div>
<ul class="simple">
<li><p><span class="docutils literal"><span class="pre">-t</span> <span class="pre">イメージ名[:タグ名]</span></span> : Docker を利用する上でほぼ必須。</p></li>
</ul>
</li>
<li><p>Dockerfile という名前ではない Dockerfile を指定して Docker イメージを作成する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image build -f <span class="o">{</span>Dockerfile名<span class="o">}</span> -t イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> Dockerfile配置ディレクトリのパス
</pre></div>
</div>
</li>
<li><p>イメージをビルド時に、 <span class="docutils literal">FROM</span> で指定したベースイメージを強制的に再取得させる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image build --pull<span class="o">=</span><span class="nb">true</span> -t example/echo:latest
</pre></div>
</div>
<ul class="simple">
<li><p>実際の運用では、 <span class="docutils literal">latest</span> ではなく、タグ付けされたイメージを利用することがほとんど</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-search">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_12"></div><h2><a class="toc-backref" href="#id37">2.2.2 docker search --- イメージの検索</a></h2>
<div class="section" id="docker-hub">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_13"></div><h3><a class="toc-backref" href="#id38">Docker Hub</a></h3>
<ul class="simple">
<li><p>Docker イメージのレジストリ</p></li>
<li><p>ユーザーや組織が GitHub と同様にリポジトリを持つことができる</p></li>
<li><p>リポジトリでそれぞれの Docker イメージを管理していく</p></li>
<li><p>全てのイメージのベースとなるような OS (CentOS や Ubuntu) のリポジトリ、言語のランタイムや著名なミドルウェアのイメージのリポジトリなどたくさんある</p></li>
<li><p>全ての Docker イメージを自前で用意する必要はない、ほかの人が作ったものを活用していく</p></li>
</ul>
</div>
<div class="section" id="id9">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_14"></div><h3><a class="toc-backref" href="#id39">検索する</a></h3>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker search <span class="o">[</span>options<span class="o">]</span> 検索キーワード
</pre></div>
</div>
<ul>
<li><p>mysql を検索する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker search --limit <span class="m">5</span> mysql
<span class="go">NAME                         DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span>
<span class="go">mysql                        MySQL is a widely used, open-source relation…   7249                [OK]</span>
<span class="go">mysql/mysql-server           Optimized MySQL Server Docker images. Create…   535                                     [OK]</span>
<span class="go">zabbix/zabbix-server-mysql   Zabbix Server with MySQL database support       136                                     [OK]</span>
<span class="go">mysql/mysql-cluster          Experimental MySQL Cluster Docker images. Cr…   33</span>
<span class="go">circleci/mysql               MySQL is a widely used, open-source relation…   7</span>
</pre></div>
</div>
<ul class="simple">
<li><p>スターの降順で表示される</p></li>
<li><p><span class="docutils literal"><span class="pre">--limit</span> 5</span> : 表示件数を5件に制限する</p></li>
<li><p>名前空間はオーナー名</p></li>
<li><p>公式リポジトリは、名前空間が表示されない</p></li>
<li><p>公式リポジトリの名前空間には一律で <span class="docutils literal">library</span> がついているので、正式名称は <span class="docutils literal">library/mysql</span></p></li>
</ul>
</li>
<li><p>リリースされているタグの一覧を表示する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> curl -s <span class="s1">'https://hub.docker.com/v2/repositories/library/golang/tags/?page_size=10'</span> <span class="p">|</span> jq -r <span class="s1">'.results[].name'</span>
<span class="go">1.10</span>
<span class="go">1.10.5</span>
<span class="go">latest</span>
<span class="go">1</span>
<span class="go">1.11</span>
<span class="go">1.11.2</span>
<span class="go">1.10-alpine3.7</span>
<span class="go">1.10.5-alpine3.7</span>
<span class="go">1.10-alpine</span>
<span class="go">1.10.5-alpine</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-image-pull">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_15"></div><h2><a class="toc-backref" href="#id40">2.2.3 docker image pull --- イメージの取得</a></h2>
<p>Docker レジストリから Docker イメージをダウンロードする</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image pull <span class="o">[</span>options<span class="o">]</span> リポジトリ名<span class="o">[</span>:タグ名<span class="o">]</span>
</pre></div>
</div>
<ul>
<li><p>指定するリポジトリ名とタグ名は Docker Hub に存在するものを指定する</p></li>
<li><p>jenkins の Docker イメージをダウンロードする</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image pull jenkins:latest
</pre></div>
</div>
<ul class="simple">
<li><p>タグ名を省略した場合は、デフォルトタグ (多くは latest) が利用される</p></li>
<li><p>ダウンロードしてきたイメージは、そのまま Docker コンテナとして利用できる</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-image-ls">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_16"></div><h2><a class="toc-backref" href="#id41">2.2.4 docker image ls --- イメージの一覧</a></h2>
<p>Docker ホストに保持されているイメージの一覧を表示する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image ls <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>リポジトリ名<span class="o">[</span>:タグ名<span class="o">]]</span>
</pre></div>
</div>
<ul>
<li><p>Docker ホスト: Docker デーモンを実行しているホスト環境のこと</p></li>
<li><p>リモートから pull してきたイメージも、自分でビルドしたイメージも両方表示される</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="docutils literal">IMAGE ID</span> : イメージのID。コンテナのIDとは違うものなので、混同しないこと。</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-image-tag">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_17"></div><h2><a class="toc-backref" href="#id42">2.2.5 docker image tag --- イメージのタグ付け</a></h2>
<div class="section" id="id10">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_18"></div><h3><a class="toc-backref" href="#id43">Docker イメージのバージョン</a></h3>
<p>イメージのバージョンとは、正確にはイメージIDのこと</p>
<ul>
<li><p>イメージのビルドの度に、別の <span class="docutils literal">IMAGE ID</span> が割り振られる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        3 hours ago         750MB</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ひとつのタグに紐づけられるイメージはひとつまで (上の例だと <span class="docutils literal">latest</span> )</p></li>
<li><p>古いイメージはタグとの紐づけが解除されて <span class="docutils literal">&lt;none&gt;</span> になる</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_19"></div><h3><a class="toc-backref" href="#id44">イメージIDへのタグ付け</a></h3>
<p>イメージID にタグ名という形で別名をつけることができる</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image tag 元イメージ名<span class="o">[</span>:タグ<span class="o">]</span> 新イメージ名<span class="o">[</span>:タグ<span class="o">]</span>
</pre></div>
</div>
<ul>
<li><p>ある特定のイメージIDを持つ Docker イメージを識別しやすくするために使う。</p></li>
<li><p><span class="docutils literal">latest</span> は Git で言うところの master ブランチのようなもの。常に最新のイメージ。</p></li>
<li><p><span class="docutils literal">example/echo</span> の <span class="docutils literal">latest</span> に 0.1.0 のタグをつける</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image tag example/echo:latest example/echo:0.1.0
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     0.1.0               ed899b24590f        3 hours ago         750MB</span>
<span class="go">example/echo                     latest              ed899b24590f        3 hours ago         750MB</span>
<span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        3 hours ago         750MB</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-image-push">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_20"></div><h2><a class="toc-backref" href="#id45">2.2.6 docker image push --- イメージの公開</a></h2>
<p>Docker イメージを Docker Hub などのレジストリに登録する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image push <span class="o">[</span>options<span class="o">]</span> リポジトリ名<span class="o">[</span>:タグ<span class="o">]</span>
</pre></div>
</div>
<div class="section" id="docker-hub-push">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_21"></div><h3><a class="toc-backref" href="#id46">Docker Hub にイメージを push する</a></h3>
<ol class="arabic">
<li><p>Docker Hub にログインする</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker login -u your_docker_id -p your_docker_pw
</pre></div>
</div>
</blockquote>
</li>
<li><p>名前空間を自分のリポジトリ名にする</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image tag example/echo:latest fumi23/echo:latest
<span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     0.1.0               ed899b24590f        4 hours ago         750MB</span>
<span class="go">example/echo                     latest              ed899b24590f        4 hours ago         750MB</span>
<span class="go">fumi23/echo                      latest              ed899b24590f        4 hours ago         750MB</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Docker Hub は、自分が所有している、または、所属している organization のリポジトリにしか push できない</p></li>
</ul>
</blockquote>
</li>
<li><p>Docker Hub に push する</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image push fumi23/echo:latest
<span class="go">The push refers to repository [docker.io/fumi23/echo]</span>
<span class="go">b2aff6d696c0: Preparing</span>
<span class="go">f18abb5d7b45: Preparing</span>
<span class="go">f18abb5d7b45: Pushed</span>
<span class="go">latest: digest: sha256:834be6348517746b53f3d44c56b580a0cea74161b86426cc006b1c066c48e047 size: 2417</span>
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="id11">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_22"></div><h1><a class="toc-backref" href="#id47">2.3 Docker コンテナの操作</a></h1>
<p>Docker コンテナは外から見ると仮想環境、ファイルシステムとアプリケーションが同梱されている箱のようなもの。</p>
<div class="section" id="id12">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_23"></div><h2><a class="toc-backref" href="#id48">2.3.1 Docker コンテナのライフサイクル</a></h2>
<p>Docker コンテナは、以下の3つの状態のいずれかに分類される。</p>
<table class="colwidths-auto">
<tbody>
<tr><th class="stub"><p>実行中</p></th>
<td><p><span class="docutils literal">$ docker container run</span> で起動した状態。</p></td>
</tr>
<tr><th class="stub"><p>停止</p></th>
<td><p>停止しても、ディスクにコンテナ終了時の状態は保持される。停止したコンテナは再実行可能。</p></td>
</tr>
<tr><th class="stub"><p>破棄</p></th>
<td><ul class="simple">
<li><p>停止したコンテナは明示的に破棄しない限りディスクに残り続ける。どんどんたまる。</p></li>
<li><p>完全に不要なコンテナは破棄するほうが望ましい。</p></li>
<li><p>一度破棄したコンテナを再び開始することはできない。</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="docker-container-run">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_24"></div><h2><a class="toc-backref" href="#id49">2.3.2 docker container run --- コンテナの作成と実行</a></h2>
<p>Docker イメージからコンテナを作成、実行するコマンド。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run <span class="o">[</span>options<span class="o">]</span> イメージ名<span class="o">[</span>:タグ名<span class="o">]</span> <span class="o">[</span>コマンド<span class="o">]</span> <span class="o">[</span>コマンド引数...<span class="o">]</span>
</pre></div>
</div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run <span class="o">[</span>options<span class="o">]</span> イメージID <span class="o">[</span>コマンド<span class="o">]</span> <span class="o">[</span>コマンド引数...<span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>コンテナをバックグラウンドで実行 → HTTP リクエストしてみる → 停める</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run -d -p <span class="m">9001</span>:8080 example/echo:latest
<span class="gp">$</span> curl http://localhost:9001/
<span class="gp">$</span> docker container stop <span class="k">$(</span>docker container ls --filter <span class="s2">"ancestor=example/echo"</span> -q<span class="k">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_25"></div><h3><a class="toc-backref" href="#id50">docker container run 時に引数を与える</a></h3>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image pull alpine:3.7
<span class="gp">#</span> docker container run -it alpine:3.7  <span class="c1"># シェルに入る</span>
<span class="gp">$</span> docker container run -it alpine:3.7 uname -a
</pre></div>
</div>
</div>
<div class="section" id="id14">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_26"></div><h3><a class="toc-backref" href="#id51">名前付きコンテナ</a></h3>
<p><span class="docutils literal">NAMES</span> は適当な単語で作られた名前が自動でつけられる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES</span>
<span class="go">77699bc8d7cd        example/echo:latest   "go run /echo/main.go"   4 seconds ago       Up 2 seconds        0.0.0.0:9001-&gt;8080/tcp   modest_saha</span>
</pre></div>
</div>
<p>コンテナに好きな名前をつけられる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run --name <span class="o">[</span>好きなコンテナ名<span class="o">]</span> <span class="o">[</span>イメージ名<span class="o">]</span>:<span class="o">[</span>タグ<span class="o">]</span>
</pre></div>
</div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run -t -d --name gihyo-echo example/echo:latest
<span class="go">4864fcaf10802340449f50364891cc48b99e90538f04d8e601c5c0397ff11917</span>
<span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES</span>
<span class="go">4864fcaf1080        example/echo:latest   "go run /echo/main.go"   3 seconds ago       Up 2 seconds                                 gihyo-echo</span>
<span class="go">77699bc8d7cd        example/echo:latest   "go run /echo/main.go"   4 minutes ago       Up 4 minutes        0.0.0.0:9001-&gt;8080/tcp   modest_saha</span>
</pre></div>
</div>
<ul class="simple">
<li><p>開発時は便利だが、本番環境ではあまり使わない</p></li>
<li><p>同名のコンテナを新たに実行するには既存の同名コンテナを削除する必要があるため</p></li>
</ul>
</div>
<div class="section" id="id15">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_27"></div><h3><a class="toc-backref" href="#id52">コマンド実行時の頻出オプション</a></h3>
<dl class="field-list simple">
<dt>-i</dt>
<dd><p>docker 起動後にコンテナ側の標準入力をつなぎっぱなしにする。シェルに入ってコマンド実行ができる。</p>
</dd>
<dt>-t</dt>
<dd><p>擬似端末を有効にする。</p>
</dd>
<dt>-it</dt>
<dd><p>-i と -t はセットで使うことが多い。</p>
</dd>
<dt>--rm</dt>
<dd><p>コンテナ終了時にコンテナを破棄する。</p>
</dd>
<dt>-v</dt>
<dd><p>ホストとコンテナ間でディレクトリ、ファイルを共有する</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="docker-container-ls">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_28"></div><h2><a class="toc-backref" href="#id53">2.3.3 docker container ls --- コンテナの一覧</a></h2>
<p>実行中及び終了したコンテナの一覧を表示するコマンド</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls <span class="o">[</span>options<span class="o">]</span>
</pre></div>
</div>
<p>オプションなしで実行すると、実行中のコンテナ一覧が表示される</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run -t -d -p <span class="m">8080</span> --name fumi23 example/echo:latest
<span class="go">81e3a724ae7c730eea14b86edf354c9aad4bced96e272d1fce238760080a23b6</span>
<span class="gp">$</span> docker container run -t -d -p <span class="m">8080</span> --name fumi45 example/echo:latest
<span class="go">db029554bc5fc2e23a724892bef867c613ae5dba861e50de48914bcde23ebaf1</span>
<span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   21 seconds ago      Up 21 seconds       0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   44 seconds ago      Up 43 seconds       0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
<table class="colwidths-auto">
<caption>一覧の表示項目</caption>
<thead>
<tr><th class="head"><p>項目</p></th>
<th class="head"><p>内容</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>CONTAINER ID</p></td>
<td><p>コンテナに付与される一意の ID</p></td>
</tr>
<tr><td><p>IMAGE</p></td>
<td><p>コンテナ作成に使用された Docker イメージ</p></td>
</tr>
<tr><td><p>COMMAND</p></td>
<td><p>コンテナで実行されているアプリケーションのプロセス</p></td>
</tr>
<tr><td><p>CREATED</p></td>
<td><p>コンテナが作成されてから経過した時間</p></td>
</tr>
<tr><td><p>STATUS</p></td>
<td><p>Up (実行中), Exited(終了) といったコンテナの実行状態</p></td>
</tr>
<tr><td><p>PORTS</p></td>
<td><p>ホストのポートとコンテナポートの紐づけ (ポートフォワーディング)</p></td>
</tr>
<tr><td><p>NAMES</p></td>
<td><p>コンテナにつけられた名前</p></td>
</tr>
</tbody>
</table>
<div class="section" id="id16">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_29"></div><h3><a class="toc-backref" href="#id54">コンテナIDだけを抽出する</a></h3>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls -q
<span class="go">db029554bc5f</span>
<span class="go">81e3a724ae7c</span>
</pre></div>
</div>
</div>
<div class="section" id="filter">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_30"></div><h3><a class="toc-backref" href="#id55">filter を使う</a></h3>
<p>特定の条件に一致するものだけを抽出する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls --filter <span class="s2">"filter名=値"</span>
</pre></div>
</div>
<ul>
<li><p>コンテナ名で抽出する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls --filter <span class="s2">"name=fumi45"</span>
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
</pre></div>
</div>
</li>
<li><p>イメージ名で抽出する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls --filter <span class="s2">"ancestor=example/echo"</span>
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id17">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_31"></div><h3><a class="toc-backref" href="#id56">終了したコンテナを取得する</a></h3>
<p>終了したコンテナも含めたコンテナの一覧を取得する</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls -a
<span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="go">4864fcaf1080        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               gihyo-echo</span>
<span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<span class="go">...</span>
</pre></div>
</div>
</blockquote>
</div>
</div>
<div class="section" id="docker-container-stop">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_32"></div><h2><a class="toc-backref" href="#id57">2.3.4 docker container stop --- コンテナの停止</a></h2>
<p>実行しているコンテナを終了する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container stop コンテナIDまたはコンテナ名
</pre></div>
</div>
<ul>
<li><p>コンテナ名 <span class="docutils literal">fumi45</span> のコンテナを終了する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="gp">$</span> docker container stop fumi45
<span class="go">fumi45</span>
<span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="docker-container-restart">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_33"></div><h2><a class="toc-backref" href="#id58">2.3.5 docker container restart --- コンテナの再起動</a></h2>
<p>一度停止したコンテナは破棄しない限り、再実行できる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container restart コンテナIDまたはコンテナ名
</pre></div>
</div>
<ul>
<li><p>さっき停止した fumi45 を再実行する</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container restart fumi45
<span class="go">fumi45</span>
<span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 3 seconds        0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="docker-container-rm">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_34"></div><h2><a class="toc-backref" href="#id59">2.3.6 docker container rm --- コンテナの破棄</a></h2>
<p>停止したコンテナをディスクから完全に破棄する。 (破棄しない限りはどんどん溜まる)</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container rm コンテナIDまたはコンテナ名
</pre></div>
</div>
<ul>
<li><p>コンテナID <span class="docutils literal">4864fcaf1080</span> のコンテナを破棄する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls -a
<span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32769-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="go">4864fcaf1080        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               gihyo-echo</span>
<span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<span class="gp">$</span> docker container rm 4864fcaf1080
<span class="go">4864fcaf1080</span>
<span class="gp">$</span> docker container ls -a
<span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 minutes              0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
</pre></div>
</div>
</li>
<li><p>実行中のコンテナを停止・削除する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">db029554bc5f        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 8 minutes        0.0.0.0:32770-&gt;8080/tcp   fumi45</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="gp">$</span> docker container rm -f db029554bc5f
<span class="go">db029554bc5f</span>
<span class="gp">$</span> docker container ls
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id18">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_35"></div><h3><a class="toc-backref" href="#id60">停止の際にコンテナを破棄する</a></h3>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container run --rm
</pre></div>
</div>
<ul>
<li><p>コマンドラインツールとして利用するときなどに便利</p></li>
<li><p>停止したあとディスクに保持し続ける必要がないときに利用する</p></li>
<li><p>例)</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> <span class="s1">'{"version": 100}'</span> <span class="p">|</span> docker container run -i --rm gihyodocker/jq:1.5 <span class="s1">'.version'</span>
<span class="go">100</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="docker-container-logs">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_36"></div><h2><a class="toc-backref" href="#id61">2.3.7 docker container logs --- 標準出力の取得</a></h2>
<p>実行している特定のコンテナの標準出力を表示する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container logs <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名
</pre></div>
</div>
<ul class="simple">
<li><p>標準出力されているものだけが表示される。</p></li>
<li><p>コンテナ内でアプリケーションがファイルに出力したようなログは表示されない</p></li>
</ul>
</div>
<div class="section" id="docker-container-exec">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_37"></div><h2><a class="toc-backref" href="#id62">2.3.8 docker container exec --- 実行中コンテナでのコマンド実行</a></h2>
<p>実行中の Docker コンテナの中で、任意のコマンドを実行できる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container <span class="nb">exec</span> <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名 コンテナ内で実行するコマンド
</pre></div>
</div>
<ul>
<li><p>実行中のコンテナ <span class="docutils literal">fumi23</span> 内で <span class="docutils literal">pwd</span> コマンドを実行する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container <span class="nb">exec</span> fumi23 <span class="nb">pwd</span>
<span class="go">/go</span>
</pre></div>
</div>
</li>
<li><p>コンテナをシェル経由で操作する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container <span class="nb">exec</span> -it fumi23 sh
<span class="gp">#</span> <span class="nb">pwd</span>
<span class="go">/go</span>
<span class="gp">#</span> <span class="nb">exit</span>
</pre></div>
</div>
<ul class="simple">
<li><p>本番環境ではやらないほうがよい</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="docker-container-cp">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_38"></div><h2><a class="toc-backref" href="#id63">2.3.9 docker container cp --- ファイルのコピー</a></h2>
<p>コンテナ間、コンテナ・ホスト間でファイルをコピーできる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container cp <span class="o">[</span>options<span class="o">]</span> コンテナIDまたはコンテナ名:コンテナ内のコピー元 ホストのコピー先
</pre></div>
</div>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container cp <span class="o">[</span>options<span class="o">]</span> ホストのコピー元 コンテナIDまたはコンテナ名:コンテナ内のコピー先
</pre></div>
</div>
<ul>
<li><p>実行中のコンテナ <span class="docutils literal">fumi23</span> からホストのカレントディレクトリに <span class="docutils literal">main.go</span> をコピーする。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container cp fumi23:/echo/main.go .
</pre></div>
</div>
</li>
<li><p>ホストのカレントディレクトリから、実行中のコンテナ <span class="docutils literal">fumi23</span> に <span class="docutils literal">dummy.txt</span> をコピーする。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container cp dummy.txt fumi23:tmp
<span class="gp">$</span> docker container <span class="nb">exec</span> fumi23 ls /tmp <span class="p">|</span> grep dummy
<span class="go">dummy.txt</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>コンテナ内で生成されたファイルをホストにコピーしてきて確認するようなデバッグ用途で使ったりする。</p></li>
<li><p>破棄されていない終了したコンテナに対しても実行できる。</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="id19">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_39"></div><h1><a class="toc-backref" href="#id64">2.4 運用管理向けコマンド</a></h1>
<div class="section" id="prune">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_40"></div><h2><a class="toc-backref" href="#id65">2.4.1 prune --- 破棄</a></h2>
<p>停止しているコンテナを一括で削除する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container prune <span class="o">[</span>options<span class="o">]</span>
</pre></div>
</div>
<ul>
<li><p>途中で 確認を求められるので <span class="docutils literal">y</span> と回答する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container ls -a
<span class="go">CONTAINER ID        IMAGE                     COMMAND                  CREATED             STATUS                    PORTS                     NAMES</span>
<span class="go">81e3a724ae7c        example/echo:latest       "go run /echo/main.go"   5 days ago          Up 5 days                 0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
<span class="go">77699bc8d7cd        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               modest_saha</span>
<span class="go">9a5c3a822e39        example/echo:latest       "go run /echo/main.go"   5 days ago          Exited (2) 5 days ago                               inspiring_goldstine</span>
<span class="go">f4e8a963eae4        example/echo:latest       "go run /echo/main.go"   5 days ago          Created                                             affectionate_curie</span>
<span class="go">b113261a42b8        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 5 days ago                               ecstatic_tesla</span>
<span class="go">449ccdc8c99e        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               determined_zhukovsky</span>
<span class="go">a11a7535307a        example/echo:latest       "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               vibrant_borg</span>
<span class="go">b8c42ba791e7        294c33d2b845              "go run /echo/main.go"   6 days ago          Exited (2) 6 days ago                               admiring_lalande</span>
<span class="go">9cd48659badb        gihyodocker/echo:latest   "go run /echo/main.go"   7 days ago          Exited (2) 7 days ago                               dreamy_saha</span>
<span class="go">fe9ad59901bb        gihyodocker/echo:latest   "go run /echo/main.go"   5 weeks ago         Exited (255) 7 days ago   0.0.0.0:9000-&gt;8080/tcp    vigilant_snyder</span>
<span class="gp">$</span> docker container prune
<span class="go">WARNING! This will remove all stopped containers.</span>
<span class="go">Are you sure you want to continue? [y/N] y</span>
<span class="go">Deleted Containers:</span>
<span class="go">77699bc8d7cd6992526da9171db5d10b511f46f4b12b8d68706825fddf8b7a18</span>
<span class="go">9a5c3a822e39ee5f811f21634c38cd4918a35e2e1ca0f680d170576fe98e7f33</span>
<span class="go">f4e8a963eae40f539e92b95b14236af8e614977d20bd80d11e0f870e6bfcdb0c</span>
<span class="go">b113261a42b8fb110cd1984904dccfe859067abd078637ff37804ad5f00c3ff5</span>
<span class="go">449ccdc8c99e72ecd791b036417632ec3e7944f1e7ab14c5b96d7e4caec0e58b</span>
<span class="go">a11a7535307a23a8121c7ac241e4df40f125a3187f556451e9014aa4f710046f</span>
<span class="go">b8c42ba791e7f266451bddc6d74b1eb196bf3b55d072bc8ff2f64a7f9c096648</span>
<span class="go">9cd48659badb6c5e8add684becbc91bae8fbeb6a928ae93618d8ff9fe3d36a6d</span>
<span class="go">fe9ad59901bbdd5dbad274eddc2def85fc49361a6299a7ae02f7693944c928ef</span>

<span class="go">Total reclaimed space: 29.41MB</span>
<span class="gp">$</span> docker container ls -a
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   5 days ago          Up 5 days           0.0.0.0:32768-&gt;8080/tcp   fumi23</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id20">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_41"></div><h3><a class="toc-backref" href="#id66">Docker イメージを一括削除する</a></h3>
<p>Docker イメージも一括で削除できる。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image prune <span class="o">[</span>options<span class="o">]</span>
</pre></div>
</div>
<ul>
<li><p>途中で 確認を求められるので <span class="docutils literal">y</span> と回答する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     0.1.0               ed899b24590f        6 days ago          750MB</span>
<span class="go">example/echo                     latest              ed899b24590f        6 days ago          750MB</span>
<span class="go">fumi23/echo                      latest              ed899b24590f        6 days ago          750MB</span>
<span class="go">&lt;none&gt;                           &lt;none&gt;              294c33d2b845        7 days ago          750MB</span>
<span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<span class="go">gihyodocker/jq                   1.5                 fb12c33cec33        10 months ago       5.31MB</span>
<span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
<span class="gp">$</span> docker image prune
<span class="go">WARNING! This will remove all dangling images.</span>
<span class="go">Are you sure you want to continue? [y/N] y</span>
<span class="go">Deleted Images:</span>
<span class="go">deleted: sha256:294c33d2b8454edba3e291fff2e2e477b287df30c13734a72fd8018cc4b4be9b</span>
<span class="go">deleted: sha256:73db87b05d43898a40665c4a8614bb383fc6bf050a37601e29da0fdb3f71e724</span>
<span class="go">deleted: sha256:8b7b14181869de8ccf721f5fc57b37b9d9ff533dc4c67201ff7b78862a67553c</span>

<span class="go">Total reclaimed space: 395B</span>
<span class="gp">$</span> docker image ls
<span class="go">REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="go">example/echo                     0.1.0               ed899b24590f        6 days ago          750MB</span>
<span class="go">example/echo                     latest              ed899b24590f        6 days ago          750MB</span>
<span class="go">fumi23/echo                      latest              ed899b24590f        6 days ago          750MB</span>
<span class="go">jenkins                          latest              cd14cecfdb3a        3 months ago        696MB</span>
<span class="go">golang                           1.9                 ef89ef5c42a9        3 months ago        750MB</span>
<span class="go">gihyodocker/jq                   1.5                 fb12c33cec33        10 months ago       5.31MB</span>
<span class="go">gihyodocker/echo                 latest              3dbbae6eb30d        10 months ago       733MB</span>
</pre></div>
</div>
<ul class="simple">
<li><p>残っているイメージは、 Docker が自動で判断して残しているもの。実行中のコンテナのイメージであるなど理由がある。</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id21">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_42"></div><h3><a class="toc-backref" href="#id67">Docker リソースを一括削除する</a></h3>
<p>利用されていない Docker コンテナやイメージ、ボリューム、ネットワークといった全ての Docker リソースを一括で削除する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker system prune <span class="o">[</span>options<span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="docker-container-stats">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_43"></div><h2><a class="toc-backref" href="#id68">2.4.2 docker container stats --- 利用状況の取得</a></h2>
<p>コンテナ単位でシステムリソースの利用状況を取得する。</p>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container stats <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>表示するコンテナID...<span class="o">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>実行例</p></li>
</ul>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container stats
<span class="go">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span>
<span class="go">81e3a724ae7c        fumi23              0.00%               8.012MiB / 1.952GiB   0.40%               19.1kB / 0B         1.21MB / 8.19kB     17</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="docker-compose">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_44"></div><h1><a class="toc-backref" href="#id69">2.5 Docker Compose でマルチコンテナを実行する</a></h1>
<ul class="simple">
<li><p>Docker コンテナ = 単一のアプリケーションと言い換えることができる</p></li>
<li><p>仮想サーバとっは対象とする粒度が異なる</p></li>
<li><p>複数存在するコンテナ同士が通信し、かつ、コンテナがコンテナの依存関係を持つはず</p>
<ul>
<li><p>コンテナの挙動を制御するための設定ファイルや環境変数の与え方</p></li>
<li><p>コンテナ同士の依存関係</p></li>
<li><p>ポートフォワーディング</p></li>
</ul>
</li>
</ul>
<div class="section" id="id22">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_45"></div><h2><a class="toc-backref" href="#id70">2.5.1 docker-compose によるコンテナの実行</a></h2>
<p>Compose: yaml 形式の設定ファイルで、複数のコンテナ実行を一括で管理できる。</p>
<ul class="simple">
<li><p>Docker コマンドで行なっていたコンテナの実行構成を設定ファイルで管理できるようになる</p></li>
</ul>
<div class="section" id="id23">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_46"></div><h3><a class="toc-backref" href="#id71">使えるかどうか確認する</a></h3>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker-compose version
<span class="go">docker-compose version 1.22.0, build f46880f</span>
<span class="go">docker-py version: 3.4.1</span>
<span class="go">CPython version: 3.6.4</span>
<span class="go">OpenSSL version: OpenSSL 1.0.2o  27 Mar 2018</span>
</pre></div>
</div>
</div>
<div class="section" id="id24">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_47"></div><h3><a class="toc-backref" href="#id72">docker-compose でコンテナを実行する</a></h3>
<ol class="arabic">
<li><p>docker-compose.yml を用意する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># ===========================================================</span>
<span class="c1"># $ docker container run -d -p 9000:8080 example/echo:latest</span>
<span class="c1"># と同等の振る舞いを docker-compose で定義する</span>
<span class="c1"># ===========================================================</span>
<span class="c1"># docker-compose.yml ファイルフォーマットのバージョンを宣言</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">"3"</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">echo</span><span class="p p-Indicator">:</span>  <span class="c1"># コンテナの名前の定義</span>
    <span class="c1"># ここから下は実行するコンテナの定義</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">example/echo:latest</span>  <span class="c1"># 使用する Docker イメージ</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>                      <span class="c1"># ポートフォワーディングを指定</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>docker-compose.yml を作成したディレクトリで実行する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># コンテナ群を実行する</span>
$ docker-compose up -d
Creating work_echo_1 ... <span class="k">done</span>

<span class="c1"># 実行中のコンテナを一覧表示する</span>
$ docker container ls
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES
6287a2890ccb        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">8</span> seconds ago       Up <span class="m">8</span> seconds        <span class="m">0</span>.0.0.0:9000-&gt;8080/tcp    work_echo_1
81e3a724ae7c        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">6</span> days ago          Up <span class="m">6</span> days           <span class="m">0</span>.0.0.0:32768-&gt;8080/tcp   fumi23

<span class="c1"># コンテナを停止・削除する</span>
$ docker-compose down
Stopping work_echo_1 ... <span class="k">done</span>
Removing work_echo_1 ... <span class="k">done</span>
Removing network work_default
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
<div class="section" id="docker-compose-docker">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_48"></div><h3><a class="toc-backref" href="#id73">docker-compose で Docker イメージをビルドして、そのまま実行する</a></h3>
<ol class="arabic">
<li><p>docker-compose.yml を用意する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># ===========================================================</span>
<span class="c1"># docker-compose で、イメージのビルドと実行を一緒にやる</span>
<span class="c1"># ===========================================================</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">"3"</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">echo</span><span class="p p-Indicator">:</span>  <span class="c1"># コンテナの名前の定義</span>
    <span class="c1"># ここ↓から実行するコンテナの定義</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>                    <span class="c1"># Dockerfile が存在するディレクトリの相対パスを指定する</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>docker-compose.yml があるディレクトリで実行する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># コンテナ群を実行する</span>
<span class="c1"># --build: up 時に Docker イメージを必ずビルドするオプション</span>
$ docker-compose up -d --build
Creating network <span class="s2">"echo_default"</span> with the default driver
Building <span class="nb">echo</span>
Step <span class="m">1</span>/4 : FROM golang:1.9
 ---&gt; ef89ef5c42a9
Step <span class="m">2</span>/4 : RUN mkdir /echo
 ---&gt; Using cache
 ---&gt; 7caf124fb4d3
Step <span class="m">3</span>/4 : COPY main.go /echo
 ---&gt; 15b6deaeb7ce
Step <span class="m">4</span>/4 : CMD <span class="o">[</span><span class="s2">"go"</span>, <span class="s2">"run"</span>, <span class="s2">"/echo/main.go"</span><span class="o">]</span>
 ---&gt; Running in a9b3b311fdc9
Removing intermediate container a9b3b311fdc9
 ---&gt; 291b78994229
Successfully built 291b78994229
Successfully tagged echo_echo:latest
Creating echo_echo_1 ... <span class="k">done</span>

<span class="c1"># 起動したことを確認する</span>
$ docker container ls
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES
6f0571015a21        echo_echo             <span class="s2">"go run /echo/main.go"</span>   <span class="m">39</span> seconds ago      Up <span class="m">38</span> seconds       <span class="m">0</span>.0.0.0:9000-&gt;8080/tcp    echo_echo_1
81e3a724ae7c        example/echo:latest   <span class="s2">"go run /echo/main.go"</span>   <span class="m">6</span> days ago          Up <span class="m">6</span> days           <span class="m">0</span>.0.0.0:32768-&gt;8080/tcp   fumi23
</pre></div>
</div>
</blockquote>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="compose">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_49"></div><h1><a class="toc-backref" href="#id74">2.6 Compose による複数コンテナの実行</a></h1>
<div class="section" id="jenkins">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_50"></div><h2><a class="toc-backref" href="#id75">2.6.1 Jenkins コンテナを実行する</a></h2>
<ol class="arabic">
<li><p><span class="docutils literal"><span class="pre">docker-compose.yml</span></span></p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># ================================</span>
<span class="c1"># 2.6.1 Jenkins コンテナを実行する</span>
<span class="c1"># ================================</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">"3"</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">master</span><span class="p p-Indicator">:</span>  <span class="c1"># コンテナの名前</span>
    <span class="c1"># 実行するコンテナの定義</span>
    <span class="c1"># ======================</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins:latest</span>      <span class="c1"># Docker Hub に登録されている Jenkins の公式イメージを利用する</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>                    <span class="c1"># ホスト・コンテナ間でファイルを共有する仕組み</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./jenkins_home:/var/jenkins_home</span>    <span class="c1"># ホストの `./jenkins_home` に、Jenkins コンテナの `/var/jenkins_home` をマウント</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>Compose で実行する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># docker-compose.yml のあるディレクトリで実行する</span>
$ docker-compose up
</pre></div>
</div>
</blockquote>
</li>
<li><p><span class="docutils literal"><span class="pre">http://localhost:9000/</span></span> にアクセスして Jenkins の初期設定をする。</p></li>
</ol>
</div>
<div class="section" id="master-jenkins-ssh">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_51"></div><h2><a class="toc-backref" href="#id76">2.6.2 Master Jenkins の SSH 鍵を作る</a></h2>
<div class="code-block">
<div class="highlight"><pre><span></span>$ docker container <span class="nb">exec</span> -it master ssh-keygen -t rsa -C <span class="s2">""</span>
Generating public/private rsa key pair.
Enter file in which to save the key <span class="o">(</span>/var/jenkins_home/.ssh/id_rsa<span class="o">)</span>:
Created directory <span class="s1">'/var/jenkins_home/.ssh'</span>.
Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:
Enter same passphrase again:
Your identification has been saved in /var/jenkins_home/.ssh/id_rsa.
Your public key has been saved in /var/jenkins_home/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:Ee3KESkiYjH4QoZBZqPie9PH5rZ9GsVBfUaUAuXwXaY
The key<span class="err">'</span>s randomart image is:
+---<span class="o">[</span>RSA <span class="m">2048</span><span class="o">]</span>----+
<span class="p">|</span><span class="o">=</span>O.     .o ++.oo+<span class="p">|</span>
<span class="p">|</span>B++ . . o.o +o.*.<span class="p">|</span>
<span class="p">|</span>*o . . ..o . oE. <span class="p">|</span>
<span class="p">|</span>+ .     ..o .    <span class="p">|</span>
<span class="p">|</span> o     .So o     <span class="p">|</span>
<span class="p">|</span>  . . . o .      <span class="p">|</span>
<span class="p">|</span> . o . + .       <span class="p">|</span>
<span class="p">|</span>  . . +.. ..     <span class="p">|</span>
<span class="p">|</span>      .o.oo      <span class="p">|</span>
+----<span class="o">[</span>SHA256<span class="o">]</span>-----+
</pre></div>
</div>
</div>
<div class="section" id="jenkins-slave">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_52"></div><h2><a class="toc-backref" href="#id77">2.6.3 Jenkins Slave コンテナを作る</a></h2>
<ol class="arabic">
<li><p><span class="docutils literal"><span class="pre">docker-compose.yml</span></span></p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="c1"># ===================================</span>
<span class="c1"># 2.6.3 Jenkins Slave コンテナを作る</span>
<span class="c1"># ===================================</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">"3"</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="c1"># Master コンテナ</span>
  <span class="l l-Scalar l-Scalar-Plain">master</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins:latest</span>       <span class="c1"># Docker Hub に登録されている Jenkins の公式イメージを利用する</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>                      <span class="c1"># ポートフォワーディングを指定する</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9000:8080</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>                    <span class="c1"># ホスト・コンテナ間でファイルを共有する仕組み</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./jenkins_home:/var/jenkins_home</span>    <span class="c1"># ホストの `./jenkins_home` に、Jenkins コンテナの `/var/jenkins_home` をマウント</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">slave01</span>                 <span class="c1"># これで、 master から slave01 で名前解決できるようになる</span>
    <span class="c1"># pw: bb91ef8ec2e74cc3a99802a79a84df6b</span>

  <span class="c1"># Slave コンテナ</span>
  <span class="l l-Scalar l-Scalar-Plain">slave01</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">slave01</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkinsci/ssh-slave</span>    <span class="c1"># SSH 接続する Slave 用途の Docker イメージを利用する</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">JENKINS_SLAVE_SSH_PUBKEY=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCd2Nn7oT9F9JoWCWuTyjkmADAMrNZzZGCBZjT118QD3518CsaTlLmE8ikqloO9rCi58Vgi9nBhSJ0SGGG+Vx8mBZlG5V/ucq3TlbHq9Epdr8mJAaJ44F3CWNso97WIBzDEdtCAYQPRO1kEjlGBOr2JAAkYPyNEDe9o2Ta02FzqLu4WpqmqopgS6xsDWqj3BfQoJ+MCLeej865zSETyFojz8BbYH03LMhzBUeb6Yfa9LtIJgpp0KMab9p3hKlV5Es6jIVhYlVBw2NokWkOaq7KjlwTj0pmUGYIBNpgg+POpkaMt42dVNiqYxvbEzz9ZaejM3T/DIORIhKtYnnANwN4b</span>
      <span class="c1"># ↑これで Master からの SSH 接続が許可された状態になる</span>
      <span class="c1"># Slave コンテナの `~/.ssh/authorized_keys ` ファイルに Master コンテナの SSH 公開鍵が追加される。</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>Compose で実行する。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker-compose up -d
<span class="go">Creating slave01 ... done</span>
<span class="go">Creating master  ... done</span>
<span class="gp">$</span> docker-compose ps
<span class="go"> Name                Command               State                 Ports</span>
<span class="go">------------------------------------------------------------------------------------</span>
<span class="go">master    /bin/tini -- /usr/local/bi ...   Up      50000/tcp, 0.0.0.0:9000-&gt;8080/tcp</span>
<span class="go">slave01   setup-sshd                       Up      22/tcp</span>
<span class="go">(venv) FumienoMacBook-Pro:2.6.1 fumi23$ docker container ls -a</span>
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS                    PORTS                               NAMES</span>
<span class="go">91ede878960a        jenkins:latest        "/bin/tini -- /usr/l…"   42 minutes ago      Up 42 minutes             50000/tcp, 0.0.0.0:9000-&gt;8080/tcp   master</span>
<span class="go">5fc916903044        jenkinsci/ssh-slave   "setup-sshd"             42 minutes ago      Up 42 minutes             22/tcp                              slave01</span>
<span class="go">6f0571015a21        echo_echo             "go run /echo/main.go"   6 days ago          Exited (2) 15 hours ago                                       echo_echo_1</span>
<span class="go">81e3a724ae7c        example/echo:latest   "go run /echo/main.go"   12 days ago         Exited (2) 15 hours ago                                       fumi23</span>
<span class="gp">$</span> docker container <span class="nb">exec</span> master ls /usr/share/jenkins
<span class="go">jenkins.war</span>
<span class="go">ref</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p>Jenkins のバージョンが古く、SSH Slaves plugin が使えなかったので、 Docker コンテナ内の Jenkins をバージョンアップする。</p>
<blockquote>
<div class="code-block">
<div class="highlight"><pre><span></span><span class="gp">$</span> docker container <span class="nb">exec</span> -u <span class="m">0</span> -it master bash
<span class="gp">root@91ede878960a:/#</span> wget http://updates.jenkins-ci.org/download/war/2.138.3/jenkins.war
<span class="go">--2018-11-18 06:21:47--  http://updates.jenkins-ci.org/download/war/2.138.3/jenkins.war</span>
<span class="go">Resolving updates.jenkins-ci.org (updates.jenkins-ci.org)... 52.202.51.185</span>
<span class="go">Connecting to updates.jenkins-ci.org (updates.jenkins-ci.org)|52.202.51.185|:80... connected.</span>
<span class="go">HTTP request sent, awaiting response... 302 Found</span>
<span class="go">Location: http://mirrors.jenkins-ci.org/war-stable/2.138.3/jenkins.war [following]</span>
<span class="go">--2018-11-18 06:21:47--  http://mirrors.jenkins-ci.org/war-stable/2.138.3/jenkins.war</span>
<span class="go">Resolving mirrors.jenkins-ci.org (mirrors.jenkins-ci.org)... 52.202.51.185</span>
<span class="go">Reusing existing connection to updates.jenkins-ci.org:80.</span>
<span class="go">HTTP request sent, awaiting response... 302 Found</span>
<span class="go">Location: http://ftp.yz.yamagata-u.ac.jp/pub/misc/jenkins/war-stable/2.138.3/jenkins.war [following]</span>
<span class="go">--2018-11-18 06:21:48--  http://ftp.yz.yamagata-u.ac.jp/pub/misc/jenkins/war-stable/2.138.3/jenkins.war</span>
<span class="go">Resolving ftp.yz.yamagata-u.ac.jp (ftp.yz.yamagata-u.ac.jp)... 133.24.248.18, 133.24.248.16, 133.24.248.19, ...</span>
<span class="go">Connecting to ftp.yz.yamagata-u.ac.jp (ftp.yz.yamagata-u.ac.jp)|133.24.248.18|:80... connected.</span>
<span class="go">HTTP request sent, awaiting response... 200 OK</span>
<span class="go">Length: 75733340 (72M)</span>
<span class="go">Saving to: ‘jenkins.war’</span>

<span class="go">jenkins.war                                        100%[===============================================================================================================&gt;]  72.22M  3.97MB/s    in 14s</span>

<span class="go">2018-11-18 06:22:01 (5.30 MB/s) - ‘jenkins.war’ saved [75733340/75733340]</span>

<span class="gp">root@91ede878960a:/#</span> ls -la
<span class="go">total 74032</span>
<span class="go">drwxr-xr-x   1 root root     4096 Nov 18 06:21 .</span>
<span class="go">drwxr-xr-x   1 root root     4096 Nov 18 06:21 ..</span>
<span class="go">-rwxr-xr-x   1 root root        0 Nov 18 05:03 .dockerenv</span>
<span class="go">drwxr-xr-x   1 root root     4096 Jul 17 16:20 bin</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jun 26 12:03 boot</span>
<span class="go">drwxr-xr-x   5 root root      340 Nov 18 05:03 dev</span>
<span class="go">lrwxrwxrwx   1 root root       33 Jul 17 06:16 docker-java-home -&gt; /usr/lib/jvm/java-8-openjdk-amd64</span>
<span class="go">drwxr-xr-x   1 root root     4096 Nov 18 05:03 etc</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jun 26 12:03 home</span>
<span class="go">-rw-r--r--   1 root root 75733340 Nov  9 01:03 jenkins.war</span>
<span class="go">drwxr-xr-x   1 root root     4096 Jul 16 00:00 lib</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 lib64</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 media</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 mnt</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 opt</span>
<span class="go">dr-xr-xr-x 187 root root        0 Nov 18 05:03 proc</span>
<span class="go">drwx------   2 root root     4096 Jul 16 00:00 root</span>
<span class="go">drwxr-xr-x   3 root root     4096 Jul 16 00:00 run</span>
<span class="go">drwxr-xr-x   1 root root     4096 Jul 17 03:13 sbin</span>
<span class="go">drwxr-xr-x   2 root root     4096 Jul 16 00:00 srv</span>
<span class="go">dr-xr-xr-x  13 root root        0 Nov 18 05:03 sys</span>
<span class="go">drwxrwxrwt   1 root root     4096 Nov 18 05:04 tmp</span>
<span class="go">drwxr-xr-x   1 root root     4096 Jul 16 00:00 usr</span>
<span class="go">drwxr-xr-x   1 root root     4096 Jul 17 16:20 var</span>
<span class="gp">root@91ede878960a:/#</span> mv ./jenkins.war /usr/share/jenkins
<span class="gp">root@91ede878960a:/#</span> chown jenkins:jenkins /usr/share/jenkins/jenkins.war
<span class="gp">root@91ede878960a:/#</span> <span class="nb">exit</span>
<span class="go">exit</span>
<span class="gp">$</span> docker-compose restart
<span class="go">Restarting master  ... done</span>
<span class="go">Restarting slave01 ... done</span>
</pre></div>
</div>
</blockquote>
</li>
<li><p><span class="docutils literal">slave01</span> ノードを追加して、 SSH の設定をする。</p></li>
</ol>
<div class="section" id="id25">
<div class="header_target" id="h_docker_introduction_2dto_2dpractice_2dcontainer_2ddevelopment_2_index_2erst_53"></div><h3><a class="toc-backref" href="#id78">参考サイト</a></h3>
<p>ありがとうございました!!</p>
<ul class="simple">
<li><p><a class="reference external" href="https://medium.com/@jimkang/how-to-start-a-new-jenkins-container-and-update-jenkins-with-docker-cf628aa495e9">https://medium.com/@jimkang/how-to-start-a-new-jenkins-container-and-update-jenkins-with-docker-cf628aa495e9</a></p></li>
</ul>
</div>
</div>
</div>
    </div>
  </main>
</div>
</div>
    </div>
  </body>

</html>